<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembuat LKPD Otomatis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk font Inter jika tersedia, fallback ke sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
            background-color: #f0f8ff; /* Light blue pastel background */
        }
        /* Mengatur agar textarea hasil LKPD bisa di-scroll dan terlihat rapi */
        #lkpdOutput {
            white-space: pre-wrap; /* Mempertahankan spasi dan baris baru */
            word-wrap: break-word; /* Memecah kata panjang */
            min-height: 400px; /* Tinggi minimal untuk area output */
            font-family: 'Consolas', 'Menlo', 'monospace'; /* Font monospace untuk tabel ASCII agar rapi */
            font-size: 0.85rem; /* Ukuran font lebih kecil untuk kerapian */
        }
        /* Styling untuk mode cetak */
        @media print {
            body {
                background-color: white; /* Hapus background di mode cetak */
                margin: 0; /* Hapus margin body */
            }
            .no-print {
                display: none !important; /* Sembunyikan elemen yang tidak perlu dicetak */
            }
            .print-area {
                width: 21cm; /* Lebar A4 */
                height: 29.7cm; /* Tinggi A4 */
                margin: 0.5cm auto; /* Margin atas/bawah 0.5cm, tengah horizontal */
                padding: 2.5cm; /* Margin 2.5 cm di semua sisi */
                box-sizing: border-box; /* Pastikan padding termasuk dalam lebar/tinggi */
                font-family: 'Arial', 'Times New Roman', serif; /* Font untuk cetak */
                font-size: 11pt; /* Ukuran font untuk cetak */
                line-height: 1.5; /* Spasi baris untuk cetak */
            }
            /* Style khusus untuk judul dan subjudul dalam cetakan */
            .print-area h1 {
                text-align: center;
                margin-bottom: 1em;
            }
            .print-area h2 {
                text-align: left;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
            }
        }

        /* Modal Styles */
        .api-key-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .api-key-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 500px;
            text-align: center;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }
        .api-key-modal.show .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6; /* Blue-500 */
            margin-bottom: 1rem;
        }
        .modal-content p {
            color: #4b5563;
            margin-bottom: 1.5rem;
        }
        .modal-content input[type="password"] {
            margin-bottom: 1.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
        .modal-content .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap; /* Allow buttons to wrap on small screens */
        }
        .modal-content .button-group button {
            flex-grow: 1; /* Allow buttons to grow */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-content .button-group .btn-save {
            background-color: #3b82f6;
            color: white;
        }
        .modal-content .button-group .btn-save:hover {
            background-color: #2563eb;
        }
        .modal-content .button-group .btn-clear {
            background-color: #ef4444; /* Red-500 */
            color: white;
        }
        .modal-content .button-group .btn-clear:hover {
            background-color: #dc2626; /* Red-600 */
        }
        .modal-content .button-group .btn-close {
            background-color: #6b7280; /* Gray-500 */
            color: white;
        }
        .modal-content .button-group .btn-close:hover {
            background-color: #4b5563; /* Gray-600 */
        }

        /* Settings Button Styles - NEW */
        #settingsButton { /* Ganti #settingsIcon jadi #settingsButton */
            position: absolute;
            top: 1.5rem; /* Sesuaikan jarak dari atas */
            right: 1.5rem; /* Sesuaikan jarak dari kanan */
            cursor: pointer;
            padding: 0.5rem 1rem; /* Padding tombol */
            background-color: #e0f2fe; /* Warna latar belakang tombol */
            color: #2563eb; /* Warna teks tombol */
            border: 1px solid #93c5fd; /* Border tombol */
            border-radius: 0.5rem; /* Sudut tombol membulat */
            font-size: 0.875rem; /* Ukuran font */
            font-weight: 600; /* Ketebalan font */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out;
            z-index: 10; /* Pastikan tombol di atas elemen lain */
            display: flex; /* Agar teks dan ikon (jika ada) bisa diatur dengan flexbox */
            align-items: center; /* Vertikal tengah */
            gap: 0.5rem; /* Jarak antara teks dan ikon (jika ditambahkan) */
        }
        #settingsButton:hover {
            background-color: #bfdbfe; /* Warna latar belakang saat hover */
            color: #1e40af; /* Warna teks saat hover */
            transform: scale(1.02); /* Efek membesar sedikit saat hover */
        }

        /* Temporary Message Box for showMessageBox function */
        .temp-message {
            position: fixed; /* Use fixed for global placement */
            top: 1rem; /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001; /* Above modal */
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 90%;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .temp-message.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg border border-blue-200" style="position: relative;">
        <button id="settingsButton" class="no-print">
            Pengaturan Kunci
        </button>
        <h1 class="text-3xl md:text-4xl font-bold text-center text-blue-700 mb-6">Pembuat LKPD Otomatis</h1>
        <p class="text-center text-gray-600 mb-8">Isi formulir di bawah ini untuk membuat Lembar Kerja Peserta Didik (LKPD) mengikuti format referensi.</p>

        <div class="no-print space-y-4 mb-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="namaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                    <input type="text" id="namaSekolah" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: SMPN 5 Harapan Bangsa">
                </div>
                <div>
                    <label for="namaGuru" class="block text-sm font-medium text-gray-700">Nama Guru</label>
                    <input type="text" id="namaGuru" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Ibu Siti Aminah, S.Pd.">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="mataPelajaran" class="block text-sm font-medium text-gray-700">Mata Pelajaran</label>
                    <input type="text" id="mataPelajaran" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Ilmu Pengetahuan Alam (IPA)">
                </div>
                <div>
                    <label for="kelasSemester" class="block text-sm font-medium text-gray-700">Kelas/Semester</label>
                    <input type="text" id="kelasSemester" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: VII / Genap">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="topikPembelajaran" class="block text-sm font-medium text-gray-700">Topik Pembelajaran</label>
                    <input type="text" id="topikPembelajaran" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Perubahan Wujud Zat">
                </div>
                <div>
                    <label for="modelPembelajaran" class="block text-sm font-medium text-gray-700">Model Pembelajaran</label>
                    <input type="text" id="modelPembelajaran" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Discovery Learning">
                </div>
            </div>

            <div>
                <label for="alokasiWaktu" class="block text-sm font-medium text-gray-700">Alokasi Waktu</label>
                <input type="text" id="alokasiWaktu" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: 2 x 40 menit">
            </div>

            <div>
                <label for="kdIpk" class="block text-sm font-medium text-gray-700">Kompetensi Dasar & Indikator Pencapaian (KD & IPK)</label>
                <textarea id="kdIpk" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh:&#10;KD: 3.3 Menganalisis konsep suhu...&#10;IPK: 3.3.1 Menjelaskan konsep perubahan wujud zat..."></textarea>
            </div>

            <div class="mt-4 p-4 border border-blue-200 rounded-md bg-blue-50">
                <p class="text-sm font-semibold text-blue-800 mb-2">Input untuk "LK I" (Kegiatan Pengelompokan)</p>
                <p class="text-xs text-gray-600 mb-2">Deskripsikan kegiatan atau gambar yang ingin Anda klasifikasikan di LK I. Contoh: "Sedang mencuci mobil", "Merobek-robek kertas". AI akan membantu mengelompokkannya.</p>
                <div>
                    <label for="lk1Activity1" class="block text-sm font-medium text-gray-700">Kegiatan/Gambar 1</label>
                    <input type="text" id="lk1Activity1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Sedang mencuci mobil">
                </div>
                <div class="mt-2">
                    <label for="lk1Activity2" class="block text-sm font-medium text-gray-700">Kegiatan/Gambar 2</label>
                    <input type="text" id="lk1Activity2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Menyalakan semua alat elektronik di rumah">
                </div>
                <div class="mt-2">
                    <label for="lk1Activity3" class="block text-sm font-medium text-gray-700">Kegiatan/Gambar 3</label>
                    <input type="text" id="lk1Activity3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Contoh: Mendaur ulang bahan bekas menjadi tas">
                </div>
                <div class="mt-2">
                    <label for="tingkatKesulitanSoal" class="block text-sm font-medium text-gray-700">Tingkat Kesulitan Soal (Untuk Soal Latihan)</label>
                    <select id="tingkatKesulitanSoal" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">Pilih Tingkat Kesulitan</option>
                        <option value="mudah">Mudah</option>
                        <option value="sedang">Sedang</option>
                        <option value="sulit">Sulit</option>
                    </select>
                </div>
            </div>
            
            <button id="buatLkpdBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                Buat LKPD dengan AI
            </button>
        </div>

        <div class="mt-8">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4 text-center no-print">Hasil LKPD Anda</h2>
            <textarea id="lkpdOutput" readonly class="w-full p-4 border border-green-300 rounded-md bg-green-50 text-gray-800 overflow-auto shadow-inner"></textarea>
            <div class="mt-4 flex justify-center no-print">
                <button id="copyLkpdBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out mr-2">
                    Salin LKPD
                </button>
                <button id="clearFormBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Bersihkan Formulir
                </button>
            </div>
            <p class="text-sm text-gray-500 mt-4 text-center no-print">
                Salin teks di atas, lalu tempel ke aplikasi pengolah kata (MS Word/Google Docs) untuk pengaturan tata letak cetak (margin, spasi, font A4) agar hasil cetak maksimal.
            </p>
        </div>
    </div>

    <div id="geminiApiKeyModal" class="api-key-modal">
        <div class="modal-content">
            <h2>Masukkan Kunci API Gemini Anda</h2>
            <p>
                Untuk menggunakan fitur pembuatan LKPD, Anda perlu memasukkan Kunci API Gemini Anda.
                Kunci ini akan disimpan secara lokal di browser Anda dan tidak akan dikirim ke server mana pun.
            </p>
            <input type="password" id="modalGeminiApiKeyInput" placeholder="Contoh: AIzaSyC_..." class="focus:ring-2 focus:ring-blue-300">
            <div class="button-group">
                <button id="modalSaveGeminiApiKeyBtn" class="btn-save">Simpan Kunci</button>
                <button id="modalClearGeminiApiKeyBtn" class="btn-clear">Hapus Kunci</button>
                <button id="modalCloseGeminiApiKeyBtn" class="btn-close">Tutup</button>
            </div>
            <p class="mt-4 text-sm text-gray-500">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">Dapatkan Kunci API Gemini Anda di sini</a>
            </p>
        </div>
    </div>
    <script>
        // Global references for elements accessed by multiple functions or early during load
        const namaSekolahInput = document.getElementById('namaSekolah');
        const namaGuruInput = document.getElementById('namaGuru');
        const mataPelajaranInput = document.getElementById('mataPelajaran');
        const kelasSemesterInput = document.getElementById('kelasSemester');
        const topikPembelajaranInput = document.getElementById('topikPembelajaran');
        const modelPembelajaranInput = document.getElementById('modelPembelajaran');
        const alokasiWaktuInput = document.getElementById('alokasiWaktu');
        const kdIpkInput = document.getElementById('kdIpk');
        const lk1Activity1Input = document.getElementById('lk1Activity1');
        const lk1Activity2Input = document.getElementById('lk1Activity2');
        const lk1Activity3Input = document.getElementById('lk1Activity3');
        const tingkatKesulitanSoalInput = document.getElementById('tingkatKesulitanSoal');
        const lkpdOutput = document.getElementById('lkpdOutput');
        const buatLkpdBtn = document.getElementById('buatLkpdBtn');
        const copyLkpdBtn = document.getElementById('copyLkpdBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        const geminiApiKeyModal = document.getElementById('geminiApiKeyModal');
        const modalGeminiApiKeyInput = document.getElementById('modalGeminiApiKeyInput');
        const modalSaveGeminiApiKeyBtn = document.getElementById('modalSaveGeminiApiKeyBtn');
        const modalClearGeminiApiKeyBtn = document.getElementById('modalClearGeminiApiKeyBtn');
        const modalCloseGeminiApiKeyBtn = document.getElementById('modalCloseGeminiApiKeyBtn');

        // NEW: Settings Button Element (Ganti dari settingsIcon)
        const settingsButton = document.getElementById('settingsButton');

        // Fungsi untuk menampilkan pesan temporer
        function showMessageBox(message, isError = false) {
            const messageContainer = document.querySelector('.max-w-4xl.mx-auto'); 
            let tempMessageDiv = messageContainer.querySelector('.temp-message');
            
            if (!tempMessageDiv) {
                tempMessageDiv = document.createElement('div');
                tempMessageDiv.className = `temp-message p-3 rounded-md mb-4 text-center text-sm absolute top-4 left-1/2 -translate-x-1/2 w-3/4 z-20 shadow-lg`;
                messageContainer.insertBefore(tempMessageDiv, messageContainer.firstChild); 
            }

            tempMessageDiv.textContent = message;
            tempMessageDiv.classList.remove('bg-red-100', 'text-red-800', 'border-red-300', 'bg-blue-100', 'text-blue-800', 'border-blue-300', 'hidden', 'show'); // Remove 'show' if it was there
            tempMessageDiv.classList.add(isError ? 'bg-red-100', 'text-red-800', 'border-red-300' : 'bg-blue-100', 'text-blue-800', 'border-blue-300');
            tempMessageDiv.classList.add('show'); // Add 'show' to trigger transition

            // Hapus pesan setelah 3 detik
            setTimeout(() => {
                tempMessageDiv.classList.remove('show'); // Remove 'show' for fade out
                setTimeout(() => tempMessageDiv.classList.add('hidden'), 300); // Hide after transition
            }, 3000);
        }

        // Function to save Gemini API Key
        function saveGeminiApiKey() {
            const apiKey = modalGeminiApiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                geminiApiKeyModal.classList.remove('show'); 
                showMessageBox('Kunci API Gemini berhasil disimpan.', false);
            } else {
                showMessageBox('Kunci API Gemini tidak boleh kosong.', true);
            }
        }

        // Function to clear Gemini API Key
        function clearGeminiApiKey() {
            localStorage.removeItem('geminiApiKey');
            modalGeminiApiKeyInput.value = '';
            showMessageBox('Kunci API Gemini telah dihapus.', false);
        }

        // Fungsi untuk membuat teks LKPD dengan Gemini AI
        const generateLkpd = async () => {
            // Ambil API Key dari localStorage
            const apiKey = localStorage.getItem('geminiApiKey');

            // Validasi API Key sebelum melanjutkan
            if (!apiKey || apiKey.trim() === '') {
                showMessageBox('Kunci API Gemini diperlukan untuk membuat LKPD. Silakan masukkan.', true);
                geminiApiKeyModal.classList.add('show'); 
                modalGeminiApiKeyInput.value = ''; 
                return; // Berhenti eksekusi jika API Key tidak ada
            }

            const namaSekolah = namaSekolahInput.value.trim();
            const namaGuru = namaGuruInput.value.trim();
            const mataPelajaran = mataPelajaranInput.value.trim();
            const kelasSemester = kelasSemesterInput.value.trim();
            const topikPembelajaran = topikPembelajaranInput.value.trim();
            const modelPembelajaran = modelPembelajaranInput.value.trim();
            const alokasiWaktu = alokasiWaktuInput.value.trim();
            const kdIpk = kdIpkInput.value.trim();
            const tingkatKesulitanSoal = tingkatKesulitanSoalInput.value.trim();
            const lk1Activities = [
                lk1Activity1Input.value.trim(),
                lk1Activity2Input.value.trim(),
                lk1Activity3Input.value.trim()
            ].filter(Boolean); 

            // Validasi input penting sebelum memanggil API
            if (!topikPembelajaran || !mataPelajaran || !kelasSemester || !kdIpk) {
                showMessageBox("Mohon lengkapi kolom 'Topik Pembelajaran', 'Mata Pelajaran', 'Kelas/Semester', dan 'Kompetensi Dasar & IPK' untuk mendapatkan hasil yang optimal dari AI.", true);
                lkpdOutput.value = ""; 
                return; // Berhenti eksekusi jika input penting tidak lengkap
            }

            lkpdOutput.value = "Membuat konten LKPD cerdas dengan AI... Mohon tunggu sebentar. Proses ini mungkin memakan waktu beberapa detik.";
            buatLkpdBtn.disabled = true; 

            try {
                // Isi tetap untuk petunjuk penggunaan (tidak dihasilkan AI)
                const petunjukPenggunaan = `
PETUNJUK PENGGUNAAN LKPD:
1.  Bacalah dan pahami setiap petunjuk pada LKPD dengan teliti.
2.  Diskusikan setiap pertanyaan atau tugas yang diberikan bersama anggota kelompok.
3.  Gunakan berbagai sumber belajar (buku, internet) untuk membantu menjawab pertanyaan.
4.  Kerjakan LKPD secara jujur dan bertanggung jawab.
5.  Jika ada kesulitan atau hal yang kurang dipahami, tanyakan kepada guru.
6.  Presentasikan hasil diskusi kelompok Anda di depan kelas.
                `.trim();

                // Prompt untuk Gemini API
                const prompt = `Sebagai seorang guru yang ingin membuat Lembar Kerja Peserta Didik (LKPD) untuk mata pelajaran ${mataPelajaran} dengan topik "${topikPembelajaran}" untuk kelas ${kelasSemester}, dan model pembelajaran ${modelPembelajaran}.
                Berdasarkan Kompetensi Dasar & Indikator Pencapaian berikut:
                "${kdIpk}"

                Buatkan konten LKPD dalam format JSON, dengan detail berikut:
                1.  **tujuanPembelajaranGenerated**: Minimal 3 tujuan pembelajaran yang spesifik, terukur, dapat dicapai, relevan, dan berbatas waktu (SMART) menggunakan kata kerja operasional yang tepat. Setiap tujuan dalam satu baris terpisah dengan diawali tanda hubung (-).
                2.  **pengantarKontekstualGenerated**: Sebuah paragraf pengantar singkat (2-4 kalimat) yang menarik, relevan, dan kontekstual untuk siswa, terkait topik "${topikPembelajaran}".
                3.  **kegiatanIntiPanduan**: Detail panduan untuk setiap tahapan model pembelajaran ${modelPembelajaran}. Ini harus berupa satu blok teks panjang yang mencakup:
                    * A. Observasi (Stimulation): Petunjuk spesifik untuk observasi terkait topik.
                    * B. Diskusi (Problem Statement): Petunjuk untuk mengidentifikasi masalah dari observasi.
                    * C. Analisis (Data Collection & Processing): Petunjuk untuk mengumpulkan dan mengolah informasi.
                    * D. Aplikasi (Verification): Petunjuk untuk menerapkan konsep.
                    * E. Refleksi (Generalization): Petunjuk untuk menyimpulkan pembelajaran.
                    Pastikan setiap sub-bagian ini diawali dengan huruf kapital (A., B., C., D., E.) dan nama tahapannya dalam kurung.
                4.  **lk1Instruction**: Instruksi singkat (1-2 kalimat) untuk kegiatan LK I.
                5.  **lk1Classification**: Sebuah array objek, di mana setiap objek memiliki \`activity\` (string) dan \`type\` (string, bisa "Penghematan" atau "Tidak Penghematan"). Gunakan kegiatan berikut: ${JSON.stringify(lk1Activities)}. Jika ada kegiatan yang tidak jelas, masukkan sebagai "Belum Diklasifikasikan". Tambahkan setidaknya 2-3 contoh tambahan kegiatan penghematan/tidak penghematan yang relevan dengan topik jika \`lk1Activities\` kurang dari 3.
                6.  **lk2InitialStatement**: Sebuah pernyataan awal atau fakta (2-3 kalimat) seperti "Dalam pembuatan 1 rim kertas..." yang relevan dengan topik "${topikPembelajaran}" jika memungkinkan, atau pernyataan umum.
                7.  **lk2Steps**: Sebuah array string berisi 5-6 langkah kegiatan untuk LK II, termasuk diskusi, penulisan hasil, dan presentasi (jika relevan).
                8.  **daftarSoal**: Sebuah array berisi minimal 5-7 soal latihan atau tugas esai/analisis/diskusi yang mendorong berpikir kritis, bukan hanya hafalan, terkait topik "${topikPembelajaran}" dan tujuan pembelajaran. Jika tingkat kesulitan soal adalah "${tingkatKesulitanSoal}", sesuaikan kompleksitas soalnya. Setiap elemen array adalah satu soal.
                9.  **refleksiDiriSiswaGenerated**: Minimal 4 pertanyaan reflektif bagi siswa setelah mengerjakan LKPD, dalam format daftar berpoin.
                10. **catatanGuruMotivasi**: Satu paragraf singkat (1-2 kalimat) berisi catatan atau motivasi penutup dari guru untuk siswa.

                Pastikan semua teks yang dihasilkan menggunakan bahasa Indonesia yang baik dan baku, dan sesuai untuk konteks pendidikan menengah. Jangan gunakan markdown di dalam nilai string JSON.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                tujuanPembelajaranGenerated: { type: "STRING" },
                                pengantarKontekstualGenerated: { type: "STRING" },
                                kegiatanIntiPanduan: { type: "STRING" },
                                lk1Instruction: { type: "STRING" },
                                lk1Classification: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            activity: { type: "STRING" },
                                            type: { type: "STRING", enum: ["Penghematan", "Tidak Penghematan", "Belum Diklasifikasikan"] }
                                        }
                                    }
                                },
                                lk2InitialStatement: { type: "STRING" },
                                lk2Steps: {
                                    type: "ARRAY",
                                    items: { type: "STRING" }
                                },
                                daftarSoal: {
                                    type: "ARRAY",
                                    items: { type: "STRING" }
                                },
                                refleksiDiriSiswaGenerated: { type: "STRING" },
                                catatanGuruMotivasi: { type: "STRING" }
                            }
                        }
                    }
                };

                // Menggunakan apiKey dari localStorage yang sudah divalidasi di awal fungsi
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const jsonString = result.candidates[0].content.parts[0].text;
                    // Hapus backticks dan kata 'json' jika AI mengembalikan dalam format code block
                    const cleanedJsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim(); 
                    
                    console.log("Raw JSON response from Gemini:", cleanedJsonString); // Log for debugging

                    const jsonResponse = JSON.parse(cleanedJsonString); // Parse string yang sudah bersih
                    console.log("Parsed JSON response:", jsonResponse); // Log for debugging

                    const {
                        tujuanPembelajaranGenerated,
                        pengantarKontekstualGenerated,
                        kegiatanIntiPanduan,
                        lk1Instruction,
                        lk1Classification,
                        lk2InitialStatement,
                        lk2Steps,
                        daftarSoal,
                        refleksiDiriSiswaGenerated,
                        catatanGuruMotivasi
                    } = jsonResponse;

                    // Pastikan lk1Classification adalah array yang valid
                    const finalLk1Classification = Array.isArray(lk1Classification) ? lk1Classification : [];

                    // --- Mulai membangun teks LKPD dengan format PDF referensi ---
                    let lkpdText = `
LEMBAR KERJA PESERTA DIDIK (LKPD)

Kelas/Semester    : ${kelasSemester || '[Kelas / Semester]'}
Tema              : ${mataPelajaran || '[Mata Pelajaran]'}
Sub Tema          : ${topikPembelajaran || '[Topik Pembelajaran]'}
Pembelajaran      : [Pembelajaran AI-generated atau manual, misal: 1]
Muatan Pelajaran  : ${mataPelajaran || '[Mata Pelajaran]'}

Tujuan Pembelajaran

${tujuanPembelajaranGenerated || '[Tujuan Pembelajaran belum dihasilkan]'}

---

LK I
${lk1Instruction || 'Kelompokkanlah kegiatan berikut berdasarkan apakah kegiatan tersebut menghemat penggunaan sumber daya alam atau tidak, dan berikan penjelasannya.'}

${pengantarKontekstualGenerated || '[Pengantar kontekstual belum dihasilkan]'}

${kegiatanIntiPanduan ? `
KEGIATAN INTI (Model Pembelajaran: ${modelPembelajaran || '[Model Pembelajaran]'})
${kegiatanIntiPanduan}` : '[Panduan Kegiatan Inti belum dihasilkan]'}

+-----+----------------------------------+-----------------------+------------------------+
| No. | Kegiatan Gambar                  | Melakukan Penghematan | Tidak Melakukan        |
|     |                                  |                       | Penghematan            |
+-----+----------------------------------+-----------------------+------------------------+
`;
                    // Tambahkan baris klasifikasi dari AI
                    finalLk1Classification.forEach((item, index) => {
                        // Tambahkan pengecekan null/undefined untuk item dan item.activity
                        if (item && typeof item.activity === 'string' && typeof item.type === 'string') {
                            const no = String(index + 1).padEnd(3);
                            const activity = item.activity.padEnd(32).substring(0, 32);
                            const isHemat = item.type === "Penghematan" ? "  X  " : "     ";
                            const isTidakHemat = item.type === "Tidak Penghematan" ? "  X  " : "     ";
                            lkpdText += `| ${no}| ${activity} | ${isHemat.padEnd(21)} | ${isTidakHemat.padEnd(22)} |\n`;
                            lkpdText += `+-----+----------------------------------+-----------------------+------------------------+\n`;
                        } else {
                            console.warn("Item malformed in lk1Classification, skipping:", item);
                        }
                    });

                    lkpdText += `

LK II
Menghemat Kertas dalam Kehidupan Sehari-hari

Langkah Kegiatan:
1. Perhatikan pernyataan berikut.
    ${lk2InitialStatement || '[Pernyataan awal belum dihasilkan]'}

`;
                    // Tambahkan langkah kegiatan dari AI
                    // Pastikan lk2Steps adalah array yang valid
                    const finalLk2Steps = Array.isArray(lk2Steps) ? lk2Steps : [];
                    finalLk2Steps.forEach((step, index) => {
                        lkpdText += `${index + 2}. ${step}\n`; // Dimulai dari nomor 2 karena nomor 1 sudah pernyataan awal
                    });

                    // Tambahkan area kosong untuk jawaban
                    lkpdText += `\n(Gunakan area di bawah ini untuk menulis hasil diskusimu)\n`;
                    for (let i = 0; i < 5; i++) {
                        lkpdText += ".......................................................................................................................................................\n";
                    }
                    lkpdText += "\n"; // Spasi setelah garis

                    lkpdText += `

SOAL LATIHAN / TUGAS:
${daftarSoal && Array.isArray(daftarSoal) && daftarSoal.length > 0 ? daftarSoal.map((soal, index) => `${index + 1}. ${soal}`).join('\n\n') : '[Daftar soal belum dihasilkan]'}

---
REFLEKSI DIRI SISWA:
${refleksiDiriSiswaGenerated || '[Refleksi diri siswa belum dihasilkan]'}

---
RUBRIK PENILAIAN KEGIATAN KELOMPOK:
(Untuk diisi guru)

+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| No. | Aspek Penilaian                  | Skor 4 (Sangat Baik)  | Skor 3 (Baik)         | Skor 2 (Cukup)        | Skor 1 (Kurang)       |
+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| 1   | Partisipasi dalam Diskusi        | Aktif berkontribusi & | Aktif berkontribusi   | Cukup berpartisipasi  | Kurang/tidak          |
|     |                                  | membantu              |                       |                       | berpartisipasi        |
+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| 2   | Kerja Sama Kelompok              | Sangat baik, saling   | Baik, ada kolaborasi  | Cukup kooperatif      | Kurang/tidak kooperatif|
|     |                                  | mendukung             |                       |                       |                       |
+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| 3   | Kualitas Jawaban/Hasil           | Jawaban/hasil         | Jawaban/hasil akurat  | Jawaban/hasil kurang  | Jawaban/hasil tidak   |
|     |                                  | sangat akurat         |                       | akurat                | akurat                |
+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| 4   | Presentasi Kelompok              | Sangat jelas,         | Jelas & percaya diri  | Cukup jelas           | Kurang jelas/tidak    |
|     |                                  | percaya diri          |                       |                       | percaya diri          |
+-----+----------------------------------+-----------------------+-----------------------+-----------------------+-----------------------+

---
CATATAN GURU/MOTIVASI PENUTUP:
${catatanGuruMotivasi || '[Catatan guru/motivasi penutup belum dihasilkan]'}

---
Note: Nama Pembuat LKPD    : ${namaGuru || '[Nama Guru]'}
      Instansi            : ${namaSekolah || '[Nama Sekolah]'}
      Alamat Surel        : [email@contoh.com (Isi manual)]
      Whatsapp            : [08xxxxxxxxxx (Isi manual)]
                        `.trim();

                    lkpdOutput.value = lkpdText;

                } else {
                    showMessageBox("Maaf, tidak dapat menghasilkan konten LKPD. Struktur respons dari AI tidak sesuai atau kosong. Coba lagi atau sesuaikan input Anda.", true);
                    lkpdOutput.value = ""; 
                }
            } catch (error) {
                console.error('Error generating LKPD content:', error);
                if (error instanceof SyntaxError && error.message.includes("JSON")) {
                    showMessageBox(`Terjadi kesalahan saat memproses respons AI (JSON Error): ${error.message}. Respons AI mungkin tidak dalam format yang diharapkan. Coba lagi atau sesuaikan prompt.`, true);
                } else {
                    showMessageBox(`Terjadi kesalahan saat memanggil AI: ${error.message}. Pastikan semua kolom penting terisi dan koneksi internet Anda stabil, dan Kunci API Gemini Anda benar dan aktif. Coba lagi.`, true);
                }
                lkpdOutput.value = ""; 
            } finally {
                buatLkpdBtn.disabled = false; 
            }
        };

        // Fungsi untuk menyalin teks LKPD ke clipboard
        const copyLkpd = () => {
            lkpdOutput.select(); 
            document.execCommand('copy'); 
            showMessageBox('Teks LKPD berhasil disalin ke clipboard!', false); 
        };

        // Fungsi untuk membersihkan formulir
        const clearForm = () => {
            namaSekolahInput.value = '';
            namaGuruInput.value = '';
            namaPelajaranInput.value = ''; // Memastikan semua input dibersihkan
            kelasSemesterInput.value = '';
            topikPembelajaranInput.value = '';
            modelPembelajaranInput.value = '';
            alokasiWaktuInput.value = '';
            kdIpkInput.value = '';
            lk1Activity1Input.value = '';
            lk1Activity2Input.value = '';
            lk1Activity3Input.value = '';
            tingkatKesulitanSoalInput.value = '';
            lkpdOutput.value = ''; 
        };

        // Inisialisasi utama setelah DOM siap
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners tombol utama
            buatLkpdBtn.addEventListener('click', generateLkpd);
            copyLkpdBtn.addEventListener('click', copyLkpd);
            clearFormBtn.addEventListener('click', clearForm);

            // Inisialisasi dan Event Listeners untuk Modal API Key
            // Bagian ini harus berada di dalam DOMContentLoaded,
            // tetapi saya memisahkannya ke dalam fungsi untuk kejelasan.
            const initializeModalAndListeners = () => {
                const storedApiKey = localStorage.getItem('geminiApiKey');
                if (!storedApiKey || storedApiKey.trim() === '') {
                    geminiApiKeyModal.classList.add('show'); 
                }
                modalGeminiApiKeyInput.value = storedApiKey || ''; 

                // Event Listeners tombol modal
                modalSaveGeminiApiKeyBtn.addEventListener('click', saveGeminiApiKey);
                modalClearGeminiApiKeyBtn.addEventListener('click', clearGeminiApiKey);
                modalCloseGeminiApiKeyBtn.addEventListener('click', () => {
                    geminiApiKeyModal.classList.remove('show'); 
                });

                // Event Listener untuk tombol pengaturan
                settingsButton.addEventListener('click', () => { // Ganti settingsIcon menjadi settingsButton
                    geminiApiKeyModal.classList.add('show'); 
                    modalGeminiApiKeyInput.value = localStorage.getItem('geminiApiKey') || ''; 
                });
            };
            
            initializeModalAndListeners(); // Panggil fungsi inisialisasi modal
        });
    </script>
</body>
</html>
