<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pembuat Lembar Aktivitas Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk font Inter jika tersedia, fallback ke sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
            background-color: #e6f7ff; /* Warna latar belakang biru pastel yang berbeda */
            color: #333; /* Warna teks dasar */
        }
        /* Mengatur agar textarea hasil bisa di-scroll dan terlihat rapi */
        #worksheetOutput {
            white-space: pre-wrap; /* Mempertahankan spasi dan baris baru */
            word-wrap: break-word; /* Memecah kata panjang */
            min-height: 400px; /* Tinggi minimal untuk area output */
            font-family: 'Consolas', 'Menlo', 'monospace'; /* Font monospace untuk tabel ASCII agar rapi */
            font-size: 0.875rem; /* Ukuran font lebih kecil untuk kerapian */
            line-height: 1.4; /* Spasi baris untuk keterbacaan */
        }
        /* Styling untuk mode cetak */
        @media print {
            body {
                background-color: white; /* Hapus background di mode cetak */
                margin: 0; /* Hapus margin body */
            }
            .hide-on-print {
                display: none !important; /* Sembunyikan elemen yang tidak perlu dicetak */
            }
            .printable-area {
                width: 21cm; /* Lebar A4 */
                height: 29.7cm; /* Tinggi A4 */
                margin: 0.5cm auto; /* Margin atas/bawah 0.5cm, tengah horizontal */
                padding: 2.5cm; /* Margin 2.5 cm di semua sisi */
                box-sizing: border-box; /* Pastikan padding termasuk dalam lebar/tinggi */
                font-family: 'Arial', 'Times New Roman', serif; /* Font untuk cetak */
                font-size: 11pt; /* Ukuran font untuk cetak */
                line-height: 1.5; /* Spasi baris untuk cetak */
            }
            /* Style khusus untuk judul dan subjudul dalam cetakan */
            .printable-area h1 {
                text-align: center;
                margin-bottom: 1em;
            }
            .printable-area h2 {
                text-align: left;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
            }
        }

        /* Modal Styles */
        .api-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Sedikit lebih gelap */
            backdrop-filter: blur(6px); /* Sedikit lebih blur */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .api-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content-card {
            background-color: #ffffff;
            padding: 2.5rem; /* Padding sedikit lebih besar */
            border-radius: 1rem; /* Sudut lebih membulat */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3); /* Bayangan lebih tebal */
            width: 95%;
            max-width: 550px; /* Lebar maksimum sedikit lebih besar */
            text-align: center;
            transform: translateY(-30px); /* Efek masuk sedikit lebih jauh */
            transition: transform 0.3s ease-in-out;
        }
        .api-modal-overlay.show .modal-content-card {
            transform: translateY(0);
        }
        .modal-content-card h2 {
            font-size: 1.75rem; /* Ukuran font lebih besar */
            font-weight: 800; /* Lebih tebal */
            color: #4f46e5; /* Indigo-600 */
            margin-bottom: 1.25rem;
        }
        .modal-content-card p {
            color: #6b7280; /* Gray-600 */
            margin-bottom: 1.75rem;
        }
        .modal-content-card input[type="password"] {
            margin-bottom: 1.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.625rem; /* Sedikit lebih membulat */
            padding: 0.875rem 1.25rem; /* Padding lebih besar */
            width: 100%;
            font-size: 1rem;
        }
        .modal-actions-group {
            display: flex;
            gap: 1.25rem; /* Jarak antar tombol lebih besar */
            justify-content: center;
            flex-wrap: wrap;
        }
        .modal-actions-group button {
            flex-grow: 1;
            padding: 0.875rem 1.75rem; /* Padding lebih besar */
            border-radius: 0.625rem;
            font-weight: 700; /* Lebih tebal */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Transisi untuk semua properti */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Bayangan tombol */
        }
        .modal-actions-group .btn-action-save {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
        }
        .modal-actions-group .btn-action-save:hover {
            background-color: #4338ca; /* Indigo-700 */
            transform: translateY(-2px); /* Efek angkat */
        }
        .modal-actions-group .btn-action-clear {
            background-color: #ef4444; /* Rose-500 */
            color: white;
        }
        .modal-actions-group .btn-action-clear:hover {
            background-color: #dc2626; /* Rose-600 */
            transform: translateY(-2px);
        }
        .modal-actions-group .btn-action-close {
            background-color: #6b7280; /* Slate-500 */
            color: white;
        }
        .modal-actions-group .btn-action-close:hover {
            background-color: #4b5563; /* Slate-600 */
            transform: translateY(-2px);
        }

        /* Settings Button Styles - PENYESUAIAN DI SINI */
        #settingsControlBtn {
            /* Default styles for mobile (button with text and icon) */
            position: static;
            width: fit-content;
            height: auto;
            padding: 0.625rem 1.25rem;
            margin-top: 1.5rem;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            background-color: #e0f2fe;
            color: #2563eb;
            border: 1px solid #93c5fd;
            border-radius: 0.625rem;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            z-index: 10; /* Lower z-index for mobile flow */
            cursor: pointer;
        }

        /* Hover for mobile button */
        #settingsControlBtn:hover {
            background-color: #bfdbfe;
            color: #1e40af;
            transform: scale(1.03);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        /* Media query for larger screens (desktop) */
        @media (min-width: 768px) {
            #settingsControlBtn {
                position: fixed; /* Ubah dari static ke fixed */
                top: 1.5rem; /* Jarak dari atas viewport */
                right: 1.5rem; /* Jarak dari kanan viewport */
                width: 3rem; /* Lebar tombol */
                height: 3rem; /* Tinggi tombol */
                padding: 0.5rem; /* Padding untuk ikon */
                background-color: #4f46e5; /* Indigo-600 */
                color: white; /* Warna ikon putih */
                border: none; /* Hapus border */
                border-radius: 50%; /* Membuat tombol bulat */
                justify-content: center; /* Pusatkan ikon */
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* Bayangan lebih kuat */
                z-index: 1002; /* Lebih tinggi dari modal overlay (1000) dan notifikasi (1001) */
            }
            /* Hover for desktop button */
            #settingsControlBtn:hover {
                background-color: #4338ca; /* Indigo-700 on hover */
                transform: scale(1.08); /* Efek zoom sedikit */
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3); /* Bayangan lebih kuat lagi */
            }
        }

        /* Notification Message Box */
        .notification-message {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .notification-message.show {
            opacity: 1;
            visibility: visible;
        }
        /* Warna untuk notifikasi sukses */
        .notification-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        /* Warna untuk notifikasi error */
        .notification-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
    </style>
</head>
<body class="p-5 md:p-10">
    <div class="max-w-5xl mx-auto bg-white p-8 md:p-10 rounded-2xl shadow-xl border border-indigo-200 relative">
        <!-- Tombol Pengaturan - Sekarang dengan ikon dan teks responsif -->
        <button id="settingsControlBtn" class="hide-on-print">
            <!-- Ikon untuk layar besar (desktop) -->
            <svg class="w-6 h-6 hidden md:block" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15.375a3.375 3.375 0 100-6.75 3.375 3.375 0 000 6.75z" />
                <path fill-rule="evenodd" d="M10.707 2.293a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.293.293a1 1 0 010 1.414l-.478.478a.75.75 0 000 1.06l.478.478a1 1 0 010 1.414l-.293.293a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.293-.293a1 1 0 010-1.414l.478-.478a.75.75 0 000-1.06l-.478-.478a1 1 0 010-1.414l.293-.293zM12 18a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" />
            </svg>
            <!-- Teks untuk layar kecil (mobile) -->
            <span class="md:hidden">Kelola Kunci API</span>
        </button>
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-indigo-800 mb-7">Asisten Pembuat Lembar Aktivitas Siswa</h1>
        <p class="text-center text-gray-700 mb-9">Isi detail di bawah untuk menghasilkan Lembar Aktivitas siswa (LKPD) mengikuti format standar.</p>

        <div class="hide-on-print space-y-5 mb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="schoolNameInput" class="block text-sm font-medium text-gray-700">Nama Lembaga Pendidikan</label>
                    <input type="text" id="schoolNameInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: SMA Negeri 1 Maju Bersama">
                </div>
                <div>
                    <label for="teacherNameInput" class="block text-sm font-medium text-gray-700">Nama Pengajar</label>
                    <input type="text" id="teacherNameInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Bpk. Andi Susanto, M.Pd.">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="subjectInput" class="block text-sm font-medium text-gray-700">Mata Pelajaran</label>
                    <input type="text" id="subjectInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Fisika">
                </div>
                <div>
                    <label for="gradeSemesterInput" class="block text-sm font-medium text-gray-700">Tingkat/Semester</label>
                    <input type="text" id="gradeSemesterInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: X / Ganjil">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div>
                    <label for="learningTopicInput" class="block text-sm font-medium text-gray-700">Pokok Pembelajaran</label>
                    <input type="text" id="learningTopicInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Hukum Newton tentang Gerak">
                </div>
                <div>
                    <label for="learningModelInput" class="block text-sm font-medium text-gray-700">Model Pembelajaran</label>
                    <input type="text" id="learningModelInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Problem-Based Learning">
                </div>
            </div>

            <div>
                <label for="timeAllocationInput" class="block text-sm font-medium text-gray-700">Alokasi Waktu</label>
                <input type="text" id="timeAllocationInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: 3 x 45 menit">
            </div>

            <div>
                <label for="competenceIndicatorsInput" class="block text-sm font-medium text-gray-700">Kompetensi Inti & Indikator Pencapaian (KI & IP)</label>
                <textarea id="competenceIndicatorsInput" rows="5" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh:&#10;KI: 3.4 Menganalisis pengaruh gaya terhadap percepatan benda...&#10;IP: 3.4.1 Mengidentifikasi jenis-jenis gaya..."></textarea>
            </div>

            <div class="mt-5 p-5 border border-indigo-300 rounded-xl bg-indigo-50">
                <p class="text-sm font-semibold text-indigo-800 mb-3">Input untuk "Aktivitas 1" (Kegiatan Kategorisasi)</p>
                <p class="text-xs text-gray-600 mb-3">Jelaskan kegiatan atau skenario yang ingin Anda klasifikasikan pada bagian Aktivitas 1. AI akan membantu mengategorikannya. Contoh: "Buah apel jatuh dari pohon", "Mendorong lemari".</p>
                <div>
                    <label for="activity1Scenario1" class="block text-sm font-medium text-gray-700">Skenario/Kegiatan 1</label>
                    <input type="text" id="activity1Scenario1" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Contoh: Buah apel jatuh dari pohon">
                </div>
                <div class="mt-2">
                    <label for="activity1Scenario2" class="block text-sm font-medium text-gray-700">Skenario/Kegiatan 2</label>
                    <input type="text" id="activity1Scenario2" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Contoh: Mengayuh sepeda">
                </div>
                <div class="mt-2">
                    <label for="activity1Scenario3" class="block text-sm font-medium text-gray-700">Skenario/Kegiatan 3</label>
                    <input type="text" id="activity1Scenario3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Contoh: Menarik tali tambang">
                </div>
                <div class="mt-4">
                    <label for="questionDifficulty" class="block text-sm font-medium text-gray-700">Level Kesulitan Soal (untuk Latihan)</label>
                    <select id="questionDifficulty" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base">
                        <option value="">Pilih Level Kesulitan</option>
                        <option value="pemula">Pemula</option>
                        <option value="menengah">Menengah</option>
                        <option value="mahir">Mahir</option>
                    </select>
                </div>
            </div>
            
            <button id="generateWorksheetBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Buat Lembar Aktivitas dengan AI
            </button>
        </div>

        <div class="mt-10 printable-area">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-5 text-center hide-on-print">Hasil Lembar Aktivitas Anda</h2>
            <textarea id="worksheetOutput" readonly class="w-full p-5 border border-teal-300 rounded-lg bg-teal-50 text-gray-800 overflow-auto shadow-inner"></textarea>
            <div class="mt-5 flex justify-center hide-on-print">
                <button id="copyWorksheetBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 mr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zM5 9.3V7a1 1 0 011-1h8a1 1 0 011 1v2.3l2.353 2.354a1 1 0 000-1.414l-4.95-4.95a1 1 0 00-1.414 0L3.646 9.3a1 1 0 000 1.414l4.95 4.95a1 1 0 001.414 0L17 10.3V13a2 2 0 01-2 2H6a2 2 0 01-2-2v-3.7z" />
                    </svg>
                    Salin Teks
                </button>
                <button id="clearFormBtn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    Bersihkan Formulir
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-5 text-center hide-on-print">
                Salin teks di atas, lalu tempel ke aplikasi pengolah kata (MS Word/Google Docs) untuk penyesuaian tata letak dan pencetakan optimal.
            </p>
        </div>
    </div>

    <div id="geminiApiModal" class="api-modal-overlay">
        <div class="modal-content-card">
            <h2>Konfigurasi Kunci API Gemini</h2>
            <p>
                Untuk memanfaatkan kapabilitas AI, Anda perlu memasukkan Kunci API Gemini Anda.
                Kunci ini akan disimpan secara lokal di browser Anda dan tidak akan dikirimkan ke server eksternal.
            </p>
            <input type="password" id="modalApiInput" placeholder="Contoh: AIzaSyC_..." class="focus:ring-2 focus:ring-indigo-300">
            <div class="modal-actions-group">
                <button id="saveApiBtn" class="btn-action-save">Simpan Kunci</button>
                <button id="clearApiBtn" class="btn-action-clear">Hapus Kunci</button>
                <button id="closeApiModalBtn" class="btn-action-close">Tutup</button>
            </div>
            <p class="mt-5 text-sm text-gray-500">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:underline">Dapatkan Kunci API Gemini Anda di sini</a>
            </p>
        </div>
    </div>

    <script>
        // Mendapatkan referensi elemen-elemen DOM
        const schoolNameInputElem = document.getElementById('schoolNameInput');
        const teacherNameInputElem = document.getElementById('teacherNameInput');
        const subjectInputElem = document.getElementById('subjectInput');
        const gradeSemesterInputElem = document.getElementById('gradeSemesterInput');
        const learningTopicInputElem = document.getElementById('learningTopicInput');
        const learningModelInputElem = document.getElementById('learningModelInput');
        const timeAllocationInputElem = document.getElementById('timeAllocationInput');
        const competenceIndicatorsInputElem = document.getElementById('competenceIndicatorsInput');
        const activity1Scenario1InputElem = document.getElementById('activity1Scenario1');
        const activity1Scenario2InputElem = document.getElementById('activity1Scenario2');
        const activity1Scenario3InputElem = document.getElementById('activity1Scenario3');
        const questionDifficultySelectElem = document.getElementById('questionDifficulty');
        const worksheetOutputElem = document.getElementById('worksheetOutput');
        const generateWorksheetBtn = document.getElementById('generateWorksheetBtn');
        const copyWorksheetBtn = document.getElementById('copyWorksheetBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        const geminiApiModal = document.getElementById('geminiApiModal');
        const modalApiInputElem = document.getElementById('modalApiInput');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const clearApiBtn = document.getElementById('clearApiBtn');
        const closeApiModalBtn = document.getElementById('closeApiModalBtn');
        const settingsControlBtn = document.getElementById('settingsControlBtn');

        // Fungsi untuk menampilkan pesan notifikasi temporer
        function displayNotificationMessage(message, isError = false) {
            const container = document.querySelector('.max-w-5xl.mx-auto');
            let notificationDiv = container.querySelector('.notification-message');
            
            // Buat elemen notifikasi jika belum ada
            if (!notificationDiv) {
                notificationDiv = document.createElement('div');
                notificationDiv.className = `notification-message p-3 rounded-md mb-4 text-center text-sm absolute top-4 left-1/2 -translate-x-1/2 w-3/4 z-20 shadow-lg`;
                container.insertBefore(notificationDiv, container.firstChild);
            }

            notificationDiv.textContent = message;
            // Hapus kelas warna sebelumnya dan tambahkan yang sesuai
            notificationDiv.classList.remove('notification-success', 'notification-error', 'hidden', 'show'); 
            notificationDiv.classList.add(isError ? 'notification-error' : 'notification-success');
            notificationDiv.classList.add('show'); // Tampilkan dengan transisi

            // Sembunyikan pesan setelah 3 detik
            setTimeout(() => {
                notificationDiv.classList.remove('show'); // Mulai transisi fade out
                setTimeout(() => notificationDiv.classList.add('hidden'), 300); // Sembunyikan setelah transisi selesai
            }, 3000);
        }

        // Fungsi untuk menyimpan Kunci API Gemini ke localStorage
        function storeApiKeyLocally() {
            const apiKey = modalApiInputElem.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                geminiApiModal.classList.remove('show');
                displayNotificationMessage('Kunci API Gemini berhasil disimpan.', false);
            } else {
                displayNotificationMessage('Kunci API Gemini tidak boleh kosong.', true);
            }
        }

        // Fungsi untuk menghapus Kunci API Gemini dari localStorage
        function removeApiKeyLocally() {
            localStorage.removeItem('geminiApiKey');
            modalApiInputElem.value = '';
            displayNotificationMessage('Kunci API Gemini telah dihapus.', false);
        }

        // Fungsi utama untuk menghasilkan konten Lembar Aktivitas Siswa dengan AI
        const generateWorksheetContent = async () => {
            const apiKey = localStorage.getItem('geminiApiKey');

            // Validasi Kunci API sebelum melanjutkan
            if (!apiKey || apiKey.trim() === '') {
                displayNotificationMessage('Kunci API Gemini diperlukan untuk membuat Lembar Aktivitas. Silakan masukkan di pengaturan.', true);
                geminiApiModal.classList.add('show');
                modalApiInputElem.value = ''; // Kosongkan input di modal
                return; // Berhenti eksekusi jika Kunci API tidak ada
            }

            const schoolName = schoolNameInputElem.value.trim();
            const teacherName = teacherNameInputElem.value.trim();
            const subject = subjectInputElem.value.trim();
            const gradeSemester = gradeSemesterInputElem.value.trim();
            const learningTopic = learningTopicInputElem.value.trim();
            const learningModel = learningModelInputElem.value.trim();
            const timeAllocation = timeAllocationInputElem.value.trim();
            const competenceIndicators = competenceIndicatorsInputElem.value.trim();
            const questionDifficulty = questionDifficultySelectElem.value.trim();
            const activity1Scenarios = [
                activity1Scenario1InputElem.value.trim(),
                activity1Scenario2InputElem.value.trim(),
                activity1Scenario3InputElem.value.trim()
            ].filter(Boolean); // Filter out empty strings

            // Validasi input wajib
            if (!learningTopic || !subject || !gradeSemester || !competenceIndicators) {
                displayNotificationMessage("Mohon lengkapi bidang 'Pokok Pembelajaran', 'Mata Pelajaran', 'Tingkat/Semester', dan 'Kompetensi Inti & Indikator Pencapaian' untuk hasil terbaik dari AI.", true);
                worksheetOutputElem.value = "";
                return;
            }

            worksheetOutputElem.value = "Menyiapkan konten Lembar Aktivitas cerdas dengan AI... Harap bersabar, proses ini mungkin membutuhkan waktu beberapa detik.";
            generateWorksheetBtn.disabled = true; // Nonaktifkan tombol saat proses berlangsung

            try {
                // Teks statis petunjuk penggunaan
                const usageInstructions = `
PETUNJUK PENGGUNAAN LEMBAR AKTIVITAS SISWA:
1. Baca dan pahami setiap instruksi pada Lembar Aktivitas dengan seksama.
2. Diskusikan setiap pertanyaan atau tugas yang diberikan bersama anggota kelompok Anda.
3. Manfaatkan berbagai sumber belajar (buku, internet, dll.) untuk membantu menjawab.
4. Kerjakan aktivitas secara jujur dan penuh tanggung jawab.
5. Jika menemui kesulitan atau hal yang belum jelas, jangan ragu bertanya kepada guru.
6. Siapkan diri untuk mempresentasikan hasil diskusi kelompok di depan kelas.
                `.trim();

                // Prompt untuk Gemini API
                const aiPrompt = `Sebagai seorang pendidik yang akan menyusun Lembar Aktivitas Siswa (LAS) untuk mata pelajaran ${subject} dengan pokok bahasan "${learningTopic}" bagi siswa kelas ${gradeSemester}, menggunakan model pembelajaran ${learningModel}.
                Berdasarkan Kompetensi Inti & Indikator Pencapaian berikut:
                "${competenceIndicators}"

                Mohon hasilkan konten LAS dalam format JSON, dengan poin-poin sebagai berikut:
                1. **learningObjectives**: Minimum 3 tujuan pembelajaran yang spesifik, terukur, dapat dicapai, relevan, dan berbatas waktu (SMART) menggunakan kata kerja operasional yang tepat. Setiap tujuan dalam satu baris terpisah dengan diawali tanda hubung (-).
                2. **contextualIntroduction**: Sebuah paragraf pengantar singkat (2-4 kalimat) yang menarik, relevan, dan kontekstual untuk siswa, terkait topik "${learningTopic}".
                3. **coreActivityGuidance**: Detail panduan untuk setiap tahapan model pembelajaran ${learningModel}. Ini harus berupa satu blok teks panjang yang mencakup:
                    * A. Orientasi (Stimulation): Petunjuk spesifik untuk observasi atau pemicu terkait topik.
                    * B. Identifikasi Masalah (Problem Statement): Petunjuk untuk merumuskan masalah dari observasi.
                    * C. Pengumpulan & Pengolahan Data (Data Collection & Processing): Petunjuk untuk mengumpulkan dan mengolah informasi.
                    * D. Verifikasi (Verification): Petunjuk untuk mengaplikasikan konsep atau solusi.
                    * E. Generalisasi (Generalization): Petunjuk untuk merangkum atau menyimpulkan pembelajaran.
                    Pastikan setiap sub-bagian ini diawali dengan huruf kapital (A., B., C., D., E.) dan nama tahapannya dalam kurung.
                4. **activity1Instruction**: Instruksi singkat (1-2 kalimat) untuk kegiatan Aktivitas 1.
                5. **activity1Categorization**: Sebuah array objek, di mana setiap objek memiliki \`scenario\` (string) dan \`category\` (string, bisa "Gaya Kontak" atau "Gaya Tak Kontak"). Gunakan skenario berikut: ${JSON.stringify(activity1Scenarios)}. Jika ada skenario yang tidak jelas, masukkan sebagai "Belum Terkategorikan". Tambahkan setidaknya 2-3 contoh tambahan skenario gaya kontak/tak kontak yang relevan dengan topik jika \`activity1Scenarios\` kurang dari 3.
                6. **activity2OpeningStatement**: Sebuah pernyataan pembuka atau fakta (2-3 kalimat) seperti "Ketika sebuah benda bergerak..." yang relevan dengan topik "${learningTopic}" jika memungkinkan, atau pernyataan umum.
                7. **activity2Steps**: Sebuah array string berisi 5-6 langkah kegiatan untuk Aktivitas 2, termasuk diskusi, pencatatan hasil, dan presentasi (jika sesuai).
                8. **practiceQuestions**: Sebuah array berisi minimal 5-7 soal latihan atau pertanyaan esai/analisis/diskusi yang mendorong pemikiran kritis, bukan hanya hafalan, terkait topik "${learningTopic}" dan tujuan pembelajaran. Jika level kesulitan soal adalah "${questionDifficulty}", sesuaikan kompleksitas soalnya. Setiap elemen array adalah satu soal.
                9. **studentSelfReflection**: Minimum 4 pertanyaan reflektif bagi siswa setelah menyelesaikan LAS, dalam format daftar berpoin.
                10. **teacherClosingRemarks**: Satu paragraf singkat (1-2 kalimat) berisi catatan atau motivasi penutup dari pengajar untuk siswa.

                Pastikan semua teks yang dihasilkan menggunakan bahasa Indonesia yang formal dan tepat untuk konteks pendidikan menengah. Jangan gunakan markdown di dalam nilai string JSON, kecuali untuk list items yang diawali tanda hubung.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: aiPrompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                learningObjectives: { type: "STRING" },
                                contextualIntroduction: { type: "STRING" },
                                coreActivityGuidance: { type: "STRING" },
                                activity1Instruction: { type: "STRING" },
                                activity1Categorization: {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            scenario: { type: "STRING" },
                                            category: { type: "STRING", enum: ["Gaya Kontak", "Gaya Tak Kontak", "Belum Terkategorikan"] }
                                        }
                                    }
                                },
                                activity2OpeningStatement: { type: "STRING" },
                                activity2Steps: {
                                    type: "ARRAY",
                                    items: { type: "STRING" }
                                },
                                practiceQuestions: {
                                    type: "ARRAY",
                                    items: { type: "STRING" }
                                },
                                studentSelfReflection: { type: "STRING" },
                                teacherClosingRemarks: { type: "STRING" }
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Kesalahan API: ${response.status} - ${errorData.error.message || 'Kesalahan tak dikenal'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const jsonString = result.candidates[0].content.parts[0].text;
                    // Hapus backticks dan kata 'json' jika AI mengembalikan dalam format code block
                    const cleanedJsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();
                    
                    console.log("Respons JSON mentah dari Gemini:", cleanedJsonString); // Untuk debugging

                    const parsedResponse = JSON.parse(cleanedJsonString); // Parse string yang sudah bersih
                    console.log("Respons JSON yang diurai:", parsedResponse); // Untuk debugging

                    const {
                        learningObjectives,
                        contextualIntroduction,
                        coreActivityGuidance,
                        activity1Instruction,
                        activity1Categorization,
                        activity2OpeningStatement,
                        activity2Steps,
                        practiceQuestions,
                        studentSelfReflection,
                        teacherClosingRemarks
                    } = parsedResponse;

                    // Pastikan activity1Categorization adalah array yang valid
                    const finalActivity1Categorization = Array.isArray(activity1Categorization) ? activity1Categorization : [];

                    // --- Mulai membangun teks Lembar Aktivitas Siswa ---
                    let worksheetText = `
LEMBAR AKTIVITAS SISWA (LAS)

Lembaga Pendidikan : ${schoolName || '[Nama Lembaga Pendidikan]'}
Nama Pengajar        : ${teacherName || '[Nama Pengajar]'}
Mata Pelajaran      : ${subject || '[Mata Pelajaran]'}
Tingkat/Semester    : ${gradeSemester || '[Tingkat / Semester]'}
Pokok Pembelajaran  : ${learningTopic || '[Pokok Pembelajaran]'}
Model Pembelajaran  : ${learningModel || '[Model Pembelajaran]'}
Alokasi Waktu       : ${timeAllocation || '[Alokasi Waktu]'}

---

Kompetensi Inti & Indikator Pencapaian (KI & IP):
${competenceIndicators || '[KI & IP belum terisi]'}

---

Tujuan Pembelajaran:
${learningObjectives || '[Tujuan Pembelajaran belum dihasilkan]'}

---

Pengantar:
${contextualIntroduction || '[Pengantar kontekstual belum dihasilkan]'}

---

${usageInstructions}

---

AKTIVITAS INTI (Model Pembelajaran: ${learningModel || '[Model Pembelajaran]'})
${coreActivityGuidance || '[Panduan Aktivitas Inti belum dihasilkan]'}

---

AKTIVITAS 1: Mengategorikan Jenis Gaya
${activity1Instruction || 'Kategorikanlah skenario atau kegiatan berikut berdasarkan apakah ia termasuk gaya kontak atau gaya tak kontak, dan berikan penjelasan singkat.'}

+-----+--------------------------------------+-----------------------+-----------------------+
| No. | Skenario / Kegiatan                  | Gaya Kontak           | Gaya Tak Kontak       |
+-----+--------------------------------------+-----------------------+-----------------------+
`;
                    // Tambahkan baris kategorisasi dari AI
                    finalActivity1Categorization.forEach((item, index) => {
                        if (item && typeof item.scenario === 'string' && typeof item.category === 'string') {
                            const no = String(index + 1).padEnd(3);
                            const scenario = item.scenario.padEnd(36).substring(0, 36);
                            const isKontak = item.category === "Gaya Kontak" ? "    X    " : "         "; 
                            const isTakKontak = item.category === "Gaya Tak Kontak" ? "    X    " : "         "; 
                            worksheetText += `| ${no}| ${scenario} | ${isKontak.padEnd(21)} | ${isTakKontak.padEnd(21)} |\n`;
                            worksheetText += `+-----+--------------------------------------+-----------------------+-----------------------+\n`;
                        } else {
                            console.warn("Elemen malformed dalam activity1Categorization, dilewati:", item);
                        }
                    });

                    worksheetText += `

---

AKTIVITAS 2: Mengkaji Penerapan Hukum Newton dalam Kehidupan Sehari-hari

Langkah-langkah Kegiatan:
1. Perhatikan pernyataan berikut.
    ${activity2OpeningStatement || '[Pernyataan pembuka belum dihasilkan]'}

`;
                    // Tambahkan langkah kegiatan dari AI
                    const finalActivity2Steps = Array.isArray(activity2Steps) ? activity2Steps : [];
                    finalActivity2Steps.forEach((step, index) => {
                        worksheetText += `${index + 2}. ${step}\n`; // Dimulai dari nomor 2 karena nomor 1 sudah pernyataan pembuka
                    });

                    // Tambahkan area kosong untuk jawaban
                    worksheetText += `\n(Gunakan ruang di bawah ini untuk mencatat hasil diskusi dan analisis kelompok Anda)\n`;
                    for (let i = 0; i < 6; i++) { // Jumlah baris kosong sedikit berbeda
                        worksheetText += "........................................................................................................................................................\n";
                    }
                    worksheetText += "\n"; // Spasi setelah garis

                    worksheetText += `

---
SOAL LATIHAN & TUGAS:
${practiceQuestions && Array.isArray(practiceQuestions) && practiceQuestions.length > 0 ? practiceQuestions.map((question, index) => `${index + 1}. ${question}`).join('\n\n') : '[Daftar soal latihan belum dihasilkan]'}

---
REFLEKSI DIRI SISWA:
${studentSelfReflection || '[Refleksi diri siswa belum dihasilkan]'}

---
RUBRIK PENILAIAN KELOMPOK:
(Diisi oleh Pengajar)

+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+
| No. | Aspek Penilaian                          | Skor 4 (Sangat Baik)| Skor 3 (Baik)       | Skor 2 (Cukup)      | Skor 1 (Kurang)     |
+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+
| 1   | Keaktifan Partisipasi                    | Selalu aktif &      | Sering aktif        | Cukup aktif         | Jarang/tidak aktif  |
|     |                                          | memimpin diskusi    |                     |                     |                     |
+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+
| 2   | Kolaborasi Tim                           | Sangat harmonis,    | Baik, ada           | Cukup kooperatif    | Sulit berkolaborasi |
|     |                                          | saling mendukung    | koordinasi          |                     |                     |
+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+
| 3   | Akurasi Jawaban/Hasil                    | Jawaban/hasil       | Jawaban/hasil akurat| Jawaban/hasil kurang| Jawaban/hasil tidak |
|     |                                          | sangat tepat        |                     | akurat              | akurat              |
+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+
| 4   | Kualitas Presentasi                      | Sangat jelas,       | Jelas & meyakinkan  | Cukup jelas         | Kurang jelas/ragu   |
|     |                                          | percaya diri        |                     |                     |                     |
+-----+------------------------------------------+---------------------+---------------------+---------------------+---------------------+

---
CATATAN PENGHARGAAN DARI GURU:
${teacherClosingRemarks || '[Catatan penghargaan dari guru belum dihasilkan]'}

---
Informasi Pengembang LAS:
  Nama      : ${teacherName || '[Nama Pengajar]'}
  Institusi : ${schoolName || '[Nama Lembaga Pendidikan]'}
  Email     : [emailanda@contoh.com (Mohon isi secara manual)]
  Kontak HP : [08xxxxxxxxxx (Mohon isi secara manual)]
                    `.trim();

                    worksheetOutputElem.value = worksheetText;
                    displayNotificationMessage('Lembar Aktivitas Siswa berhasil dibuat!', false);

                } else {
                    displayNotificationMessage("Maaf, gagal menghasilkan konten Lembar Aktivitas. Struktur respons dari AI tidak sesuai atau kosong. Coba lagi atau sesuaikan input Anda.", true);
                    worksheetOutputElem.value = "";
                }
            } catch (error) {
                console.error('Error saat menghasilkan konten Lembar Aktivitas:', error);
                if (error instanceof SyntaxError && error.message.includes("JSON")) {
                    displayNotificationMessage(`Terjadi kesalahan saat memproses respons AI (Kesalahan JSON): ${error.message}. Respons AI mungkin tidak dalam format yang diharapkan. Coba lagi.`, true);
                } else {
                    displayNotificationMessage(`Terjadi kesalahan saat memanggil AI: ${error.message}. Pastikan semua bidang penting terisi, koneksi internet stabil, dan Kunci API Gemini Anda valid. Coba lagi.`, true);
                }
                worksheetOutputElem.value = "";
            } finally {
                generateWorksheetBtn.disabled = false; // Aktifkan kembali tombol
            }
        };

        // Fungsi untuk menyalin teks yang dihasilkan ke clipboard
        const copyGeneratedWorksheet = () => {
            worksheetOutputElem.select();
            document.execCommand('copy');
            displayNotificationMessage('Teks Lembar Aktivitas berhasil disalin ke clipboard!', false);
        };

        // Fungsi untuk membersihkan semua bidang formulir
        const resetFormFields = () => {
            schoolNameInputElem.value = '';
            teacherNameInputElem.value = '';
            subjectInputElem.value = '';
            gradeSemesterInputElem.value = '';
            learningTopicInputElem.value = '';
            learningModelInputElem.value = '';
            timeAllocationInputElem.value = '';
            competenceIndicatorsInputElem.value = '';
            activity1Scenario1InputElem.value = '';
            activity1Scenario2InputElem.value = '';
            activity1Scenario3InputElem.value = '';
            questionDifficultySelectElem.value = '';
            worksheetOutputElem.value = '';
            displayNotificationMessage('Semua bidang formulir berhasil dibersihkan.', false);
        };

        // Inisialisasi utama setelah DOM dimuat sepenuhnya
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners untuk tombol utama aplikasi
            generateWorksheetBtn.addEventListener('click', generateWorksheetContent);
            copyWorksheetBtn.addEventListener('click', copyGeneratedWorksheet);
            clearFormBtn.addEventListener('click', resetFormFields);

            // Fungsi untuk mengatur modal Kunci API dan event listeners terkait
            const setupModalAndEventListeners = () => {
                const storedApiKey = localStorage.getItem('geminiApiKey');
                if (!storedApiKey || storedApiKey.trim() === '') {
                    geminiApiModal.classList.add('show'); // Tampilkan modal jika API Key kosong
                }
                modalApiInputElem.value = storedApiKey || ''; // Isi input dengan kunci yang tersimpan (jika ada)

                // Event Listeners untuk tombol di dalam modal
                saveApiBtn.addEventListener('click', storeApiKeyLocally);
                clearApiBtn.addEventListener('click', removeApiKeyLocally);
                closeApiModalBtn.addEventListener('click', () => {
                    geminiApiModal.classList.remove('show'); // Sembunyikan modal
                });

                // Event Listener untuk tombol pengaturan (ikon gear)
                settingsControlBtn.addEventListener('click', () => {
                    geminiApiModal.classList.add('show'); // Tampilkan modal saat tombol pengaturan diklik
                    modalApiInputElem.value = localStorage.getItem('geminiApiKey') || ''; // Perbarui nilai input modal
                });
            };
            
            setupModalAndEventListeners(); // Panggil fungsi inisialisasi modal saat DOM siap
        });
    </script>
</body>
</html>
