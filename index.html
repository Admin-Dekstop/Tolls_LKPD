<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pembuat Lembar Aktivitas Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk font Inter jika tersedia, fallback ke sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
            background-color: #e6f7ff; /* Warna latar belakang biru pastel yang berbeda */
            color: #333; /* Warna teks dasar */
        }
        /* Mengatur agar area output LKPD bisa di-scroll dan terlihat rapi */
        #worksheetOutputContainer {
            min-height: 400px; /* Tinggi minimal untuk area output */
            font-family: 'Arial', sans-serif; /* Font umum untuk dokumen */
            font-size: 1rem; /* Ukuran font dasar */
            line-height: 1.6; /* Spasi baris untuk keterbacaan */
            overflow-y: auto; /* Agar bisa discroll jika konten panjang */
        }
        #worksheetOutputContainer h1, #worksheetOutputContainer h2 {
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        #worksheetOutputContainer h1 {
            font-size: 1.5rem; /* Ukuran untuk judul utama LKPD */
            text-align: center;
            color: #1a202c; /* Hampir hitam */
        }
        #worksheetOutputContainer h2 {
            font-size: 1.25rem; /* Ukuran untuk sub-judul bagian */
            color: #2c5282; /* Biru tua */
            margin-top: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
        }
        #worksheetOutputContainer p, #worksheetOutputContainer ul, #worksheetOutputContainer ol, #worksheetOutputContainer table {
            margin-bottom: 1rem;
        }
        #worksheetOutputContainer ul, #worksheetOutputContainer ol {
            padding-left: 1.5rem;
        }
        #worksheetOutputContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #worksheetOutputContainer th, #worksheetOutputContainer td {
            border: 1px solid #cbd5e0;
            padding: 0.75rem;
            text-align: left;
        }
        #worksheetOutputContainer th {
            background-color: #f0f4f8;
            font-weight: 600;
        }

        /* Styling untuk mode cetak */
        @media print {
            body {
                background-color: white; /* Hapus background di mode cetak */
                margin: 0; /* Hapus margin body */
                padding: 0;
                font-size: 10pt; /* Ukuran font lebih kecil untuk cetak */
                line-height: 1.4;
            }
            .hide-on-print {
                display: none !important; /* Sembunyikan elemen yang tidak perlu dicetak */
            }
            .printable-area {
                width: 21cm; /* Lebar A4 */
                /* height: 29.7cm; */ /* Tinggi A4 - remove fixed height for better content flow */
                margin: 0 auto; /* Tengah horizontal, hapus margin atas/bawah yang bisa konflik dengan padding */
                padding: 2.5cm; /* Margin 2.5 cm di semua sisi */
                box-sizing: border-box; /* Pastikan padding termasuk dalam lebar/tinggi */
                font-family: 'Times New Roman', serif; /* Font untuk cetak */
            }
            .printable-area h1 {
                font-size: 18pt;
                margin-bottom: 1em;
            }
            .printable-area h2 {
                font-size: 14pt;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                border-bottom: 1px solid #ccc;
                padding-bottom: 0.2em;
            }
            .printable-area p, .printable-area ul, .printable-area ol, .printable-area table {
                margin-bottom: 0.8em;
            }
            .printable-area ul, .printable-area ol {
                padding-left: 1.2em;
            }
        }

        /* Modal Styles */
        .api-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Sedikit lebih gelap */
            backdrop-filter: blur(6px); /* Sedikit lebih blur */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .api-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content-card {
            background-color: #ffffff;
            padding: 2.5rem; /* Padding sedikit lebih besar */
            border-radius: 1rem; /* Sudut lebih membulat */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3); /* Bayangan lebih tebal */
            width: 95%;
            max-width: 550px; /* Lebar maksimum sedikit lebih besar */
            text-align: center;
            transform: translateY(-30px); /* Efek masuk sedikit lebih jauh */
            transition: transform 0.3s ease-in-out;
        }
        .api-modal-overlay.show .modal-content-card {
            transform: translateY(0);
        }
        .modal-content-card h2 {
            font-size: 1.75rem; /* Ukuran font lebih besar */
            font-weight: 800; /* Lebih tebal */
            color: #4f46e5; /* Indigo-600 */
            margin-bottom: 1.25rem;
        }
        .modal-content-card p {
            color: #6b7280; /* Gray-600 */
            margin-bottom: 1.75rem;
        }
        .modal-content-card input[type="password"] {
            margin-bottom: 1.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.625rem; /* Sedikit lebih membulat */
            padding: 0.875rem 1.25rem; /* Padding lebih besar */
            width: 100%;
            font-size: 1rem;
        }
        .modal-actions-group {
            display: flex;
            gap: 1.25rem; /* Jarak antar tombol lebih besar */
            justify-content: center;
            flex-wrap: wrap;
        }
        .modal-actions-group button {
            flex-grow: 1;
            padding: 0.875rem 1.75rem; /* Padding lebih besar */
            border-radius: 0.625rem;
            font-weight: 700; /* Lebih tebal */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Transisi untuk semua properti */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Bayangan tombol */
        }
        .modal-actions-group .btn-action-save {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
        }
        .modal-actions-group .btn-action-save:hover {
            background-color: #4338ca; /* Indigo-700 */
            transform: translateY(-2px); /* Efek angkat */
        }
        .modal-actions-group .btn-action-clear {
            background-color: #ef4444; /* Rose-500 */
            color: white;
        }
        .modal-actions-group .btn-action-clear:hover {
            background-color: #dc2626; /* Rose-600 */
            transform: translateY(-2px);
        }
        .modal-actions-group .btn-action-close {
            background-color: #6b7280; /* Slate-500 */
            color: white;
        }
        .modal-actions-group .btn-action-close:hover {
            background-color: #4b5563; /* Slate-600 */
            transform: translateY(-2px);
        }

        /* Settings Button Styles */
        #settingsControlBtn {
            position: static;
            width: fit-content;
            height: auto;
            padding: 0.625rem 1.25rem;
            margin-top: 1.5rem;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            background-color: #e0f2fe;
            color: #2563eb;
            border: 1px solid #93c5fd;
            border-radius: 0.625rem;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            z-index: 10;
            cursor: pointer;
        }
        #settingsControlBtn:hover {
            background-color: #bfdbfe;
            color: #1e40af;
            transform: scale(1.03);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        @media (min-width: 768px) {
            #settingsControlBtn {
                position: fixed;
                top: 1.5rem;
                right: 1.5rem;
                width: 3rem;
                height: 3rem;
                padding: 0.5rem;
                background-color: #4f46e5;
                color: white;
                border: none;
                border-radius: 50%;
                justify-content: center;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
                z-index: 1002;
            }
            #settingsControlBtn:hover {
                background-color: #4338ca;
                transform: scale(1.08);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            }
        }

        /* Notification Message Box */
        .notification-message {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .notification-message.show {
            opacity: 1;
            visibility: visible;
        }
        .notification-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .notification-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .required-field {
            border-color: #ef4444 !important; /* Merah untuk field wajib yang kosong */
        }
        .animate-pulse-light {
            animation: pulse-light 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-light {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="p-5 md:p-10">
    <div class="max-w-5xl mx-auto bg-white p-8 md:p-10 rounded-2xl shadow-xl border border-indigo-200 relative">
        <button id="settingsControlBtn" class="hide-on-print">
            <svg class="w-6 h-6 hidden md:block" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15.375a3.375 3.375 0 100-6.75 3.375 3.375 0 000 6.75z" />
                <path fill-rule="evenodd" d="M10.707 2.293a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.293.293a1 1 0 010 1.414l-.478.478a.75.75 0 000 1.06l.478.478a1 1 0 010 1.414l-.293.293a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.293-.293a1 1 0 010-1.414l.478-.478a.75.75 0 000-1.06l-.478-.478a1 1 0 010-1.414l.293-.293zM12 18a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" />
            </svg>
            <span class="md:hidden">Kelola Kunci API</span>
        </button>
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-indigo-800 mb-7">Asisten Pembuat Lembar Aktivitas Siswa</h1>
        <p class="text-center text-gray-700 mb-9">Isi detail di bawah untuk menghasilkan Lembar Aktivitas siswa (LKPD) yang siap cetak dan berbasis teks.</p>

        <div class="hide-on-print space-y-6 mb-12">
            <div class="p-6 border border-indigo-300 rounded-xl bg-indigo-50">
                <p class="text-lg font-bold text-indigo-800 mb-4">âœ… Data Guru & Informasi LKPD</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                    <div>
                        <label for="teacherNameInput" class="block text-sm font-medium text-gray-700">Nama Guru <span class="text-red-500">*</span></label>
                        <input type="text" id="teacherNameInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Bpk. Andi Susanto, M.Pd.">
                    </div>
                    <div>
                        <label for="gradeInput" class="block text-sm font-medium text-gray-700">Kelas <span class="text-red-500">*</span></label>
                        <input type="text" id="gradeInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: X IPA 1">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="subjectInput" class="block text-sm font-medium text-gray-700">Mata Pelajaran <span class="text-red-500">*</span></label>
                        <input type="text" id="subjectInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Fisika">
                    </div>
                    <div>
                        <label for="learningTopicInput" class="block text-sm font-medium text-gray-700">Materi Pokok <span class="text-red-500">*</span></label>
                        <input type="text" id="learningTopicInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Hukum Newton tentang Gerak">
                    </div>
                </div>
                <div class="mt-5">
                    <label for="semesterInput" class="block text-sm font-medium text-gray-700">Semester <span class="text-red-500">*</span></label>
                    <input type="text" id="semesterInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Ganjil / 1">
                </div>
            </div>

            <div class="p-6 border border-teal-300 rounded-xl bg-teal-50">
                <label for="competenceGoalsInput" class="block text-lg font-bold text-teal-800 mb-3">Kompetensi Dasar / Tujuan Pembelajaran <span class="text-red-500">*</span></label>
                <p class="text-sm text-gray-600 mb-3">Sebutkan Kompetensi Dasar atau Tujuan Pembelajaran yang ingin dicapai. AI akan mengubahnya menjadi Tujuan Pembelajaran yang berorientasi siswa.</p>
                <textarea id="competenceGoalsInput" rows="4" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-base" placeholder="Contoh:&#10;- Menganalisis pengaruh gaya terhadap percepatan benda&#10;- Mengidentifikasi jenis-jenis gaya berdasarkan kontak/non-kontak"></textarea>
            </div>

            <div class="p-6 border border-purple-300 rounded-xl bg-purple-50">
                <label for="apersepsiInput" class="block text-lg font-bold text-purple-800 mb-3">Apersepsi (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan ide atau pertanyaan pemantik terkait kehidupan sehari-hari untuk memulai LKPD. AI akan mengembangkannya menjadi 1-2 pertanyaan.</p>
                <textarea id="apersepsiInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-base" placeholder="Contoh:&#10;Pernahkah kamu memperhatikan mengapa bola yang ditendang akhirnya berhenti?"></textarea>
            </div>

            <div class="p-6 border border-orange-300 rounded-xl bg-orange-50">
                <label for="petunjukKerjaInput" class="block text-lg font-bold text-orange-800 mb-3">Petunjuk Kerja (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Sebutkan poin-poin instruksi umum yang ingin siswa ikuti. AI akan menyusunnya menjadi langkah-langkah yang jelas dan runtut.</p>
                <textarea id="petunjukKerjaInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-base" placeholder="Contoh:&#10;- Baca materi ini dengan seksama.&#10;- Diskusikan dengan kelompokmu."></textarea>
            </div>

            <div class="p-6 border border-red-300 rounded-xl bg-red-50">
                <p class="text-lg font-bold text-red-800 mb-4">Kegiatan Inti</p>
                <p class="text-sm text-gray-600 mb-3">Detailkan soal atau tugas yang akan dibuat AI.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-4">
                    <div>
                        <label for="jumlahSoalInput" class="block text-sm font-medium text-gray-700">Jumlah Soal</label>
                        <input type="number" id="jumlahSoalInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-base" min="1" max="10" value="3">
                    </div>
                    <div>
                        <label for="bentukSoalSelect" class="block text-sm font-medium text-gray-700">Bentuk Soal</label>
                        <select id="bentukSoalSelect" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-base">
                            <option value="esai">Esai / Analitis</option>
                            <option value="tabel">Tabel / Perbandingan</option>
                            <option value="studi kasus">Studi Kasus</option>
                            <option value="pemecahan masalah">Pemecahan Masalah</option>
                            <option value="argumen">Argumen</option>
                        </select>
                    </div>
                    <div>
                        <label for="levelSoalSelect" class="block text-sm font-medium text-gray-700">Level Soal</label>
                        <select id="levelSoalSelect" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-base">
                            <option value="C1">C1 (Mengingat)</option>
                            <option value="C2">C2 (Memahami)</option>
                            <option value="C3">C3 (Mengaplikasikan)</option>
                            <option value="C4" selected>C4 (Menganalisis)</option>
                            <option value="C5">C5 (Mengevaluasi)</option>
                            <option value="C6">C6 (Mencipta - HOTS)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="kegiatanIntiPromptInput" class="block text-sm font-medium text-gray-700">Konsep/Skenario untuk Kegiatan Inti (Opsional)</label>
                    <textarea id="kegiatanIntiPromptInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-base" placeholder="Contoh:&#10;Berikan kasus di mana hukum kekekalan energi berlaku.&#10;Bandingkan gaya sentripetal dan sentrifugal."></textarea>
                </div>
            </div>

            <div class="p-6 border border-yellow-300 rounded-xl bg-yellow-50">
                <label for="refleksiSiswaInput" class="block text-lg font-bold text-yellow-800 mb-3">Refleksi Siswa (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan ide pertanyaan refleksi untuk siswa (jika kosong, AI akan buat default).</p>
                <textarea id="refleksiSiswaInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 text-base" placeholder="Contoh:&#10;- Bagaimana materi ini terhubung dengan kehidupan sehari-hari saya?&#10;- Apa strategi belajar yang efektif untuk topik ini?"></textarea>
            </div>

            <div class="p-6 border border-lime-300 rounded-xl bg-lime-50">
                <label for="penilaianDiriInput" class="block text-lg font-bold text-lime-800 mb-3">Penilaian Diri (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Sebutkan poin-poin checklist untuk siswa menilai diri (jika kosong, AI akan buat default).</p>
                <textarea id="penilaianDiriInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-lime-500 focus:border-lime-500 text-base" placeholder="Contoh:&#10;- Saya dapat menjelaskan konsep dasar...&#10;- Saya mampu menyelesaikan masalah sederhana..."></textarea>
            </div>

            <div class="p-6 border border-blue-300 rounded-xl bg-blue-50">
                <label for="kesimpulanInput" class="block text-lg font-bold text-blue-800 mb-3">Kesimpulan (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan ide untuk kesimpulan singkat (jika kosong, AI akan buat default).</p>
                <textarea id="kesimpulanInput" rows="2" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" placeholder="Contoh:&#10;Hukum Newton menjelaskan..."></textarea>
                
                <label for="tugasTambahanInput" class="block text-lg font-bold text-blue-800 mt-5 mb-3">Tugas Tambahan (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan ide untuk tugas tambahan atau PR (jika kosong, AI tidak akan membuatnya).</p>
                <textarea id="tugasTambahanInput" rows="2" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-base" placeholder="Contoh:&#10;Cari contoh penerapan hukum Newton di rumah."></textarea>
            </div>

            <div class="p-6 border border-gray-300 rounded-xl bg-gray-50">
                <label class="block text-lg font-bold text-gray-800 mb-3">Ruang Catatan Bebas Siswa</label>
                <div class="flex items-center gap-4">
                    <input type="radio" id="ruangCatatanYa" name="ruangCatatan" value="ya" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                    <label for="ruangCatatanYa" class="text-sm font-medium text-gray-700">Ya, sertakan ruang catatan bebas.</label>
                </div>
                <div class="flex items-center gap-4 mt-2">
                    <input type="radio" id="ruangCatatanTidak" name="ruangCatatan" value="tidak" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="ruangCatatanTidak" class="text-sm font-medium text-gray-700">Tidak, jangan sertakan.</label>
                </div>
            </div>
            
            <button id="generateWorksheetBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>Buat Lembar Aktivitas dengan AI</span>
            </button>
        </div>

        <div class="mt-10 printable-area">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-5 text-center hide-on-print">Hasil Lembar Aktivitas Anda</h2>
            <div id="worksheetOutputContainer" class="w-full p-5 border border-teal-300 rounded-lg bg-teal-50 text-gray-800 shadow-inner">
                <p class="text-center text-gray-500 italic">LKPD yang dihasilkan AI akan muncul di sini setelah Anda mengklik "Buat Lembar Aktivitas dengan AI".</p>
            </div>

            <div class="mt-5 flex justify-center hide-on-print flex-wrap gap-3">
                <button id="copyWorksheetBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zM5 9.3V7a1 1 0 011-1h8a1 1 0 011 1v2.3l2.353 2.354a1 1 0 000-1.414l-4.95-4.95a1 1 0 00-1.414 0L3.646 9.3a1 1 0 000 1.414l4.95 4.95a1 1 0 001.414 0L17 10.3V13a2 2 0 01-2 2H6a2 2 0 01-2-2v-3.7z" />
                    </svg>
                    <span>Salin Teks</span>
                </button>
                <button id="clearFormBtn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span>Bersihkan Formulir</span>
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-5 text-center hide-on-print">
                Salin teks di atas, lalu tempel ke aplikasi pengolah kata (MS Word/Google Docs) untuk penyesuaian tata letak dan pencetakan optimal.
            </p>
        </div>
    </div>

    <div id="geminiApiModal" class="api-modal-overlay">
        <div class="modal-content-card">
            <h2>Konfigurasi Kunci API Gemini</h2>
            <p>
                Untuk memanfaatkan kapabilitas AI, Anda perlu memasukkan Kunci API Gemini Anda.
                Kunci ini akan disimpan secara lokal di browser Anda dan tidak akan dikirimkan ke server eksternal.
            </p>
            <input type="password" id="modalApiInput" placeholder="Contoh: AIzaSyC_..." class="focus:ring-2 focus:ring-indigo-300">
            <div class="modal-actions-group">
                <button id="saveApiBtn" class="btn-action-save">Simpan Kunci</button>
                <button id="clearApiBtn" class="btn-action-clear">Hapus Kunci</button>
                <button id="closeApiModalBtn" class="btn-action-close">Tutup</button>
            </div>
            <p class="mt-5 text-sm text-gray-500">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:underline">Dapatkan Kunci API Gemini Anda di sini</a>
            </p>
        </div>
    </div>

    <script>
        // Mendapatkan referensi elemen-elemen DOM
        const teacherNameInputElem = document.getElementById('teacherNameInput');
        const gradeInputElem = document.getElementById('gradeInput');
        const subjectInputElem = document.getElementById('subjectInput');
        const learningTopicInputElem = document.getElementById('learningTopicInput');
        const semesterInputElem = document.getElementById('semesterInput');
        const competenceGoalsInputElem = document.getElementById('competenceGoalsInput');
        const apersepsiInputElem = document.getElementById('apersepsiInput');
        const petunjukKerjaInputElem = document.getElementById('petunjukKerjaInput');
        
        // Inputs for Kegiatan Inti
        const jumlahSoalInputElem = document.getElementById('jumlahSoalInput');
        const bentukSoalSelectElem = document.getElementById('bentukSoalSelect');
        const levelSoalSelectElem = document.getElementById('levelSoalSelect');
        const kegiatanIntiPromptInputElem = document.getElementById('kegiatanIntiPromptInput');

        // Optional textareas
        const refleksiSiswaInputElem = document.getElementById('refleksiSiswaInput');
        const penilaianDiriInputElem = document.getElementById('penilaianDiriInput');
        const kesimpulanInputElem = document.getElementById('kesimpulanInput');
        const tugasTambahanInputElem = document.getElementById('tugasTambahanInput');

        // Radio buttons for Ruang Catatan Bebas
        const ruangCatatanYaElem = document.getElementById('ruangCatatanYa');
        const ruangCatatanTidakElem = document.getElementById('ruangCatatanTidak');


        const worksheetOutputContainer = document.getElementById('worksheetOutputContainer');
        const generateWorksheetBtn = document.getElementById('generateWorksheetBtn');
        const copyWorksheetBtn = document.getElementById('copyWorksheetBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        const geminiApiModal = document.getElementById('geminiApiModal');
        const modalApiInputElem = document.getElementById('modalApiInput');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const clearApiBtn = document.getElementById('clearApiBtn');
        const closeApiModalBtn = document.getElementById('closeApiModalBtn');
        const settingsControlBtn = document.getElementById('settingsControlBtn');

        /**
         * Menampilkan pesan notifikasi sementara di UI.
         * @param {string} message - Pesan yang akan ditampilkan.
         * @param {boolean} isError - True jika pesan adalah error, false jika sukses.
         */
        function displayNotificationMessage(message, isError = false) {
            const container = document.querySelector('.max-w-5xl.mx-auto');
            let notificationDiv = container.querySelector('.notification-message');

            if (!notificationDiv) {
                notificationDiv = document.createElement('div');
                notificationDiv.className = `notification-message p-3 rounded-md mb-4 text-center text-sm absolute top-4 left-1/2 -translate-x-1/2 w-3/4 z-20 shadow-lg`;
                container.insertBefore(notificationDiv, container.firstChild);
            }

            notificationDiv.textContent = message;
            notificationDiv.classList.remove('notification-success', 'notification-error', 'hidden', 'show');
            notificationDiv.classList.add(isError ? 'notification-error' : 'notification-success');
            notificationDiv.classList.add('show');

            setTimeout(() => {
                notificationDiv.classList.remove('show');
                setTimeout(() => notificationDiv.classList.add('hidden'), 300);
            }, 3000);
        }

        /**
         * Menyimpan Kunci API Gemini ke localStorage.
         */
        function storeApiKeyLocally() {
            const apiKey = modalApiInputElem.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                geminiApiModal.classList.remove('show');
                displayNotificationMessage('Kunci API Gemini berhasil disimpan.', false);
            } else {
                displayNotificationMessage('Kunci API Gemini tidak boleh kosong.', true);
            }
        }

        /**
         * Menghapus Kunci API Gemini dari localStorage.
         */
        function removeApiKeyLocally() {
            localStorage.removeItem('geminiApiKey');
            modalApiInputElem.value = '';
            displayNotificationMessage('Kunci API Gemini telah dihapus.', false);
        }

        /**
         * Melakukan validasi pada input-input wajib.
         * Memberikan feedback visual jika ada input yang kosong.
         * @returns {boolean} True jika semua input wajib terisi, false jika ada yang kosong.
         */
        function validateInputs() {
            let isValid = true;
            const requiredFields = [
                teacherNameInputElem,
                gradeInputElem,
                subjectInputElem,
                learningTopicInputElem,
                semesterInputElem,
                competenceGoalsInputElem
            ];

            requiredFields.forEach(field => {
                if (field.value.trim() === '') {
                    field.classList.add('required-field');
                    isValid = false;
                } else {
                    field.classList.remove('required-field');
                }
            });

            if (!isValid) {
                displayNotificationMessage("Mohon lengkapi semua bidang yang ditandai (*) sebelum membuat LKPD.", true);
            }
            return isValid;
        }

        /**
         * Fungsi utama untuk menghasilkan konten Lembar Aktivitas Siswa dengan AI.
         * Mengumpulkan data dari form, memanggil API Gemini, dan merender hasilnya ke DOM.
         */
        async function generateWorksheetContent() {
            const apiKey = localStorage.getItem('geminiApiKey');

            if (!apiKey || apiKey.trim() === '') {
                displayNotificationMessage('Kunci API Gemini diperlukan untuk membuat Lembar Aktivitas. Silakan masukkan di pengaturan.', true);
                geminiApiModal.classList.add('show');
                modalApiInputElem.value = '';
                return;
            }

            if (!validateInputs()) {
                return;
            }

            // Dapatkan semua nilai input
            const namaGuru = teacherNameInputElem.value.trim();
            const kelas = gradeInputElem.value.trim();
            const mataPelajaran = subjectInputElem.value.trim();
            const materiPokok = learningTopicInputElem.value.trim();
            const semester = semesterInputElem.value.trim();
            const tujuanPembelajaranGuru = competenceGoalsInputElem.value.trim();
            const apersepsiGuru = apersepsiInputElem.value.trim();
            const petunjukKerjaGuru = petunjukKerjaInputElem.value.trim();
            
            // Inputs for Kegiatan Inti
            const jumlahSoal = jumlahSoalInputElem.value.trim();
            const bentukSoal = bentukSoalSelectElem.value.trim();
            const levelSoal = levelSoalSelectElem.value.trim();
            const kegiatanIntiPrompt = kegiatanIntiPromptInputElem.value.trim();

            // Optional textareas
            const refleksiSiswaGuru = refleksiSiswaInputElem.value.trim();
            const penilaianDiriGuru = penilaianDiriInputElem.value.trim();
            const kesimpulanGuru = kesimpulanInputElem.value.trim();
            const tugasTambahanGuru = tugasTambahanInputElem.value.trim();
            const ruangCatatanBebasStatus = document.querySelector('input[name="ruangCatatan"]:checked').value; // 'ya' or 'tidak'

            worksheetOutputContainer.innerHTML = `<p class="text-center text-gray-500 italic animate-pulse-light">Menyiapkan konten Lembar Aktivitas cerdas dengan AI... Harap bersabar, proses ini mungkin membutuhkan waktu beberapa detik.</p>`;
            generateWorksheetBtn.disabled = true;
            generateWorksheetBtn.querySelector('span').textContent = 'Memproses...';

            try {
                // Prompt untuk Gemini API yang sangat spesifik dan memaksa output
                const aiPrompt = `
                Anda adalah Asisten AI Pendidikan profesional yang bertugas membantu guru membuat LKPD (Lembar Kerja Peserta Didik) yang SIAP CETAK, BERBASIS TEKS, TANPA GAMBAR, TANPA DIGITALISASI (QR code, link), namun tetap EFEKTIF SECARA PEDAGOGIS, REFLEKTIF, dan KOMUNIKATIF.

                Output Anda harus dalam format JSON sesuai skema yang diberikan. **SANGAT PENTING: PASTIKAN SEMUA PROPERTI JSON ADA dan TERISI DENGAN KONTEN RELEVAN.** Jika input guru untuk suatu bagian kosong atau 'kosong', Anda HARUS MENGEMBANGKAN KONTEN ASLI YANG RELEVAN DAN KOMPREHENSIF untuk bagian tersebut, bukan sekadar string kosong atau placeholder. Jangan hilangkan properti apa pun dari skema yang diminta.

                DATA INPUT GURU:
                - Nama Guru: "${namaGuru}"
                - Kelas: "${kelas}"
                - Semester: "${semester}"
                - Mata Pelajaran: "${mataPelajaran}"
                - Materi Pokok: "${materiPokok}"
                - Tujuan Pembelajaran: "${tujuanPembelajaranGuru}"
                - Apersepsi (Ide Guru): "${apersepsiGuru || 'kosong'}"
                - Petunjuk Kerja (Ide Guru): "${petunjukKerjaGuru || 'kosong'}"
                - Kegiatan Inti - Jumlah Soal: "${jumlahSoal}"
                - Kegiatan Inti - Bentuk Soal: "${bentukSoal}"
                - Kegiatan Inti - Level Soal (Bloom): "${levelSoal}"
                - Kegiatan Inti - Prompt/Skenario: "${kegiatanIntiPrompt || 'kosong'}"
                - Refleksi Siswa (Ide Guru): "${refleksiSiswaGuru || 'kosong'}"
                - Penilaian Diri (Ide Guru): "${penilaianDiriGuru || 'kosong'}"
                - Kesimpulan (Ide Guru): "${kesimpulanGuru || 'kosong'}"
                - Tugas Tambahan (Ide Guru): "${tugasTambahanGuru || 'kosong'}"
                - Ruang Catatan Bebas: "${ruangCatatanBebasStatus}"

                INSTRUKSI SANGAT SPESIFIK UNTUK SETIAP BAGIAN LKPD:

                1.  **identitasLKPD**: Gunakan data GURU secara langsung.
                2.  **tujuanPembelajaran**: Ubah Kompetensi Dasar/Tujuan Pembelajaran dari GURU menjadi bahasa siswa yang aktif dan komunikatif. Hasilkan minimal 3 poin.
                3.  **pengantarApersepsi**: HASILKAN 1-2 pertanyaan pemantik atau refleksi awal yang relevan dengan Materi Pokok. JIKA 'Apersepsi (Ide Guru)' TIDAK KOSONG, KEMBANGKAN ide tersebut secara mendalam. JIKA KOSONG, BUAT pertanyaan yang orisinal, relevan, dan menarik berdasarkan Materi Pokok.
                4.  **petunjukKerja**: HASILKAN langkah-langkah aktivitas siswa yang jelas dan runtut. Minimal 4 langkah. JIKA 'Petunjuk Kerja (Ide Guru)' TIDAK KOSONG, KEMBANGKAN ide tersebut dan urutkan secara sistematis. JIKA KOSONG, BUAT petunjuk standar yang komprehensif dan efektif.
                5.  **kegiatanInti**:
                    * **instruksiUmum**: HASILKAN instruksi umum singkat (1-2 kalimat) untuk bagian ini, relevan dengan Materi Pokok.
                    * **mainActivityContent**: JIKA 'Bentuk Soal' adalah "studi kasus", "pemecahan masalah", atau "argumen", HASILKAN paragraf/teks utama untuk studi kasus/masalah/argumen tersebut (minimal 3-5 kalimat). JIKA 'Kegiatan Inti - Prompt/Skenario' tersedia, kembangkan dari itu. JIKA 'Bentuk Soal' adalah "esai" atau "tabel", properti ini harus berupa STRING KOSONG "".
                    * **questions**: HASILKAN sejumlah soal sesuai 'Jumlah Soal' (${jumlahSoal} soal). Sesuaikan 'Level Soal' (${levelSoal}) untuk setiap soal agar bersifat terbuka dan analitis (HOTS). JIKA 'Kegiatan Inti - Prompt/Skenario' tersedia, kembangkan soal dari itu. JIKA 'Bentuk Soal' adalah "tabel" atau "perbandingan", properti ini harus berupa ARRAY KOSONG [].
                    * **tableData**: JIKA 'Bentuk Soal' adalah "tabel" atau "perbandingan", HASILKAN array objek untuk tabel dengan 2-4 kolom relevan (misal: "No.", "Poin", "Kategori/Analisis", "Keterangan") dan minimal 3-5 baris data (contoh) yang relevan dengan Materi Pokok. JIKA 'Kegiatan Inti - Prompt/Skenario' berisi data yang cocok untuk tabel, gunakan itu. JIKA TIDAK, properti ini HARUS BERUPA ARRAY KOSONG [].
                6.  **refleksiSiswa**: HASILKAN 3 pertanyaan untuk mengajak siswa mengevaluasi pemahaman mereka. JIKA 'Refleksi Siswa (Ide Guru)' TIDAK KOSONG, KEMBANGKAN ide tersebut menjadi 3 pertanyaan. JIKA KOSONG, GUNAKAN pertanyaan standar ini: "Apa yang saya pelajari hari ini?", "Bagian mana yang paling saya pahami atau sulit?", "Apa yang ingin saya tanyakan lebih lanjut terkait materi ini?".
                7.  **penilaianDiri**: HASILKAN checklist sederhana (3-5 poin) agar siswa menilai sendiri ketercapaian mereka. JIKA 'Penilaian Diri (Ide Guru)' TIDAK KOSONG, KEMBANGKAN ide tersebut menjadi poin-poin checklist. JIKA KOSONG, BUAT pernyataan checklist standar yang relevan dengan Materi Pokok.
                8.  **kesimpulan**: HASILKAN kesimpulan singkat (2-3 kalimat) yang merangkum poin penting dari LKPD. JIKA 'Kesimpulan (Ide Guru)' TIDAK KOSONG, KEMBANGKAN ide tersebut. JIKA KOSONG, BUAT kesimpulan orisinal yang relevan.
                9.  **tugasTambahan**: JIKA 'Tugas Tambahan (Ide Guru)' TIDAK KOSONG, HASILKAN tugas lanjutan atau PR ringan yang relevan dan spesifik. JIKA KOSONG, properti ini HARUS BERUPA STRING KOSONG "".
                10. **ruangCatatanBebas**: JIKA 'Ruang Catatan Bebas' adalah "ya", HASILKAN pernyataan pengantar yang ramah untuk ruang catatan bebas siswa (misal: "Gunakan ruang ini untuk mencatat ide, pertanyaan, atau pemikiran lain terkait pembelajaran."). JIKA "tidak", properti ini HARUS BERUPA STRING KOSONG "".

                KETENTUAN UMUM YANG SANGAT KETAT:
                - Output Anda HARUS MURNI TEKS. JANGAN PERNAH menyertakan gambar, ikon, QR code, atau tautan digital.
                - Gunakan bahasa Indonesia yang ramah siswa, formal, dan sesuai jenjang pendidikan.
                - Output JSON harus bersih dan VALID, tanpa karakter markdown di dalam nilai string (kecuali untuk list item yang diawali tanda hubung seperti `- item`).
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: aiPrompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "identitasLKPD": {
                                    type: "OBJECT",
                                    properties: {
                                        "mataPelajaran": { "type": "STRING" },
                                        "kelas": { "type": "STRING" },
                                        "semester": { "type": "STRING" },
                                        "materiPokok": { "type": "STRING" },
                                        "namaGuru": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["mataPelajaran", "kelas", "semester", "materiPokok", "namaGuru"]
                                },
                                "tujuanPembelajaran": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "pengantarApersepsi": { "type": "STRING" },
                                "petunjukKerja": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "kegiatanInti": {
                                    type: "OBJECT",
                                    properties: {
                                        "instruksiUmum": { "type": "STRING" },
                                        "mainActivityContent": { "type": "STRING" },
                                        "questions": { "type": "ARRAY", "items": { "type": "STRING" } },
                                        "tableData": {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    "No.": { "type": "STRING" },
                                                    "Kolom1": { "type": "STRING" },
                                                    "Kolom2": { "type": "STRING" },
                                                    "Kolom3": { "type": "STRING" },
                                                    "Kolom4": { "type": "STRING" } // Added for more flexibility in table columns
                                                }
                                            }
                                        }
                                    }
                                },
                                "refleksiSiswa": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "penilaianDiri": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "kesimpulan": { "type": "STRING" },
                                "tugasTambahan": { "type": "STRING" },
                                "ruangCatatanBebas": { "type": "STRING" }
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Kesalahan API: ${response.status} - ${errorData.error.message || 'Kesalahan tak dikenal'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const jsonString = result.candidates[0].content.parts[0].text;
                    const cleanedJsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();

                    console.log("Respons JSON mentah dari Gemini:", cleanedJsonString); // Untuk debugging

                    let parsedResponse;
                    try {
                        parsedResponse = JSON.parse(cleanedJsonString);
                        // Explicit check for valid parsed object
                        if (!parsedResponse || typeof parsedResponse !== 'object' || Array.isArray(parsedResponse)) {
                            throw new Error('Respons JSON dari AI bukan objek yang valid.');
                        }
                    } catch (e) {
                        throw new Error(`Gagal mengurai respons JSON dari AI. Respons tidak valid: ${e.message}. Respons mentah: ${cleanedJsonString.substring(0, 500)}...`);
                    }
                    console.log("Respons JSON yang diurai:", parsedResponse); // Untuk debugging

                    // --- Mulai membangun HTML Lembar Aktivitas Siswa ---
                    worksheetOutputContainer.innerHTML = ''; // Bersihkan konten sebelumnya

                    /**
                     * Helper function to create and append an HTML element.
                     * @param {string} tag - The HTML tag name (e.g., 'p', 'h1', 'ul').
                     * @param {string|string[]} content - The text content or an array of list items.
                     * @param {string} className - Tailwind CSS classes.
                     * @returns {HTMLElement} The created element.
                     */
                    function addElement(tag, content, className = '') {
                        const elem = document.createElement(tag);
                        elem.className = className;

                        // Conditional class for list types
                        if (tag === 'ul') {
                            elem.classList.add('list-disc', 'list-inside');
                        } else if (tag === 'ol') {
                            elem.classList.add('list-decimal', 'list-inside');
                        }

                        if (typeof content === 'string') {
                            elem.innerHTML = content.replace(/\n/g, '<br>'); // Handle newlines in string content
                        } else if (Array.isArray(content)) {
                            content.forEach(listItemContent => {
                                const li = document.createElement('li');
                                li.innerHTML = listItemContent.replace(/^- /, ''); // Remove hyphen for list items if present
                                elem.appendChild(li);
                            });
                        }
                        return elem;
                    }

                    /**
                     * Helper function to add blank lines for student answers.
                     * @param {HTMLElement} container - The element to append lines to.
                     * @param {number} count - Number of lines.
                     */
                    function addLine(container, count = 1) {
                        for (let i = 0; i < count; i++) {
                            const line = document.createElement('p');
                            line.className = 'text-sm text-gray-700 leading-tight';
                            line.textContent = '........................................................................................................................................................';
                            container.appendChild(line);
                        }
                    }

                    // Defensive check for main sections, providing empty objects if AI somehow misses them
                    const identitasLKPD = parsedResponse.identitasLKPD || {};
                    const kegiatanInti = parsedResponse.kegiatanInti || {};


                    // Judul Utama LKPD
                    worksheetOutputContainer.appendChild(addElement('h1', 'LEMBAR KERJA PESERTA DIDIK', 'text-xl font-bold text-center mb-4'));
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 1. Identitas LKPD
                    worksheetOutputContainer.appendChild(addElement('h2', 'Identitas LKPD', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    const identitasDiv = addElement('div', '', 'mb-4 text-base');
                    identitasDiv.innerHTML = `
                        <p><strong>Mata Pelajaran:</strong> ${identitasLKPD.mataPelajaran || '[Mata Pelajaran belum terisi]'}</p>
                        <p><strong>Kelas:</strong> ${identitasLKPD.kelas || '[Kelas belum terisi]'}</p>
                        <p><strong>Semester:</strong> ${identitasLKPD.semester || '[Semester belum terisi]'}</p>
                        <p><strong>Materi Pokok:</strong> ${identitasLKPD.materiPokok || '[Materi Pokok belum terisi]'}</p>
                        <p><strong>Nama Guru:</strong> ${identitasLKPD.namaGuru || '[Nama Guru belum terisi]'}</p>
                    `;
                    worksheetOutputContainer.appendChild(identitasDiv);
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 2. Tujuan Pembelajaran
                    worksheetOutputContainer.appendChild(addElement('h2', 'Tujuan Pembelajaran', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.tujuanPembelajaran) && parsedResponse.tujuanPembelajaran.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('ul', parsedResponse.tujuanPembelajaran, 'mb-4 text-base leading-relaxed')); // Class handled by addElement
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian Tujuan Pembelajaran dapat menjelaskan apa yang akan dipelajari siswa dalam bahasa yang mudah dipahami. Pastikan Kompetensi Dasar/Tujuan Pembelajaran diisi di formulir.', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 3. Pengantar / Apersepsi
                    worksheetOutputContainer.appendChild(addElement('h2', 'Pengantar / Apersepsi', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', parsedResponse.pengantarApersepsi || 'Bagian Pengantar dapat diisi dengan pertanyaan pemantik atau refleksi awal yang menarik terkait topik. Anda bisa memberikan ide di kolom input "Apersepsi" di atas.', 'mb-4 text-base leading-relaxed italic text-gray-500'));
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 4. Petunjuk Kerja
                    worksheetOutputContainer.appendChild(addElement('h2', 'Petunjuk Kerja', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.petunjukKerja) && parsedResponse.petunjukKerja.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('ol', parsedResponse.petunjukKerja, 'mb-4 text-base leading-relaxed')); // Class handled by addElement
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian Petunjuk Kerja ini menjelaskan langkah-langkah yang harus diikuti siswa. Anda bisa memberikan ide di kolom input "Petunjuk Kerja" di atas.', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 5. Kegiatan Inti
                    worksheetOutputContainer.appendChild(addElement('h2', 'Kegiatan Inti', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', kegiatanInti.instruksiUmum || 'Bagian ini berisi instruksi umum untuk kegiatan inti. AI akan menghasilkan tugas dan soal yang relevan.', 'mb-4 text-base leading-relaxed italic text-gray-500'));

                    // Main Activity Content (for Studi Kasus, Pemecahan Masalah, Argumen)
                    if (kegiatanInti.mainActivityContent && kegiatanInti.mainActivityContent.trim() !== '') {
                        worksheetOutputContainer.appendChild(addElement('p', kegiatanInti.mainActivityContent, 'mb-4 text-base leading-relaxed'));
                        addLine(worksheetOutputContainer, 3); // Tambah garis untuk jawaban/catatan terkait studi kasus
                    }

                    // Questions
                    if (Array.isArray(kegiatanInti.questions) && kegiatanInti.questions.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('p', 'Jawablah pertanyaan-pertanyaan berikut dengan berdiskusi:', 'font-medium mb-2 text-base'));
                        const qList = document.createElement('ol');
                        qList.className = 'list-decimal list-inside ml-4 mb-4 text-base leading-relaxed';
                        kegiatanInti.questions.forEach(q => {
                            const li = document.createElement('li');
                            li.innerHTML = `${q.replace(/^\d+\.\s*/, '')}<br>`; // Remove numbering if AI includes it
                            addLine(li, 2); // 2 garis kosong untuk jawaban
                            qList.appendChild(li);
                        });
                        worksheetOutputContainer.appendChild(qList);
                    } else if (bentukSoal !== 'tabel' && kegiatanInti.mainActivityContent.trim() === '') {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian ini akan berisi soal atau tugas. Coba berikan "Konsep/Skenario untuk Kegiatan Inti" di formulir agar AI dapat menghasilkan soal yang spesifik.', 'italic text-gray-500'));
                    }

                    // Table Data (for Tabel / Perbandingan)
                    if (Array.isArray(kegiatanInti.tableData) && kegiatanInti.tableData.length > 0) {
                        const headers = Object.keys(kegiatanInti.tableData[0] || {});
                        // Improved check for actual data beyond just headers, to avoid rendering an empty table
                        const hasActualTableContent = kegiatanInti.tableData.some(row => Object.values(row).some(cell => cell && String(cell).trim() !== ''));

                        if (hasActualTableContent && headers.length > 0) {
                            worksheetOutputContainer.appendChild(addElement('p', 'Lengkapi tabel di bawah ini:', 'font-medium mb-2 text-base'));
                            const table = document.createElement('table');
                            table.className = 'w-full border-collapse border border-gray-400 mb-4 text-base';

                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            headers.forEach(headerText => {
                                const th = document.createElement('th');
                                th.className = 'border border-gray-300 p-2 text-left bg-gray-100';
                                th.textContent = headerText;
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            const tbody = document.createElement('tbody');
                            kegiatanInti.tableData.forEach(rowData => {
                                const row = document.createElement('tr');
                                headers.forEach(key => {
                                    const td = document.createElement('td');
                                    td.className = 'border border-gray-300 p-2';
                                    td.textContent = rowData[key] || '';
                                    // Only add lines if the cell value is empty (or just whitespace)
                                    if (!rowData[key] || String(rowData[key]).trim() === '') {
                                        addLine(td, 1); // 1 garis saja untuk kolom tabel
                                    }
                                    row.appendChild(td);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            worksheetOutputContainer.appendChild(table);
                        } else if (bentukSoal === 'tabel') {
                             worksheetOutputContainer.appendChild(addElement('p', 'Anda memilih format Tabel, namun AI tidak dapat membuat tabel yang relevan dari input yang diberikan. Coba berikan Konsep/Skenario untuk Kegiatan Inti yang lebih spesifik untuk tabel (misal: "data perbandingan X dan Y").', 'italic text-gray-500'));
                        }
                    } else if (bentukSoal === 'tabel') {
                        worksheetOutputContainer.appendChild(addElement('p', 'Anda memilih format Tabel, namun AI tidak dapat membuat tabel yang relevan dari input yang diberikan. Coba berikan Konsep/Skenario untuk Kegiatan Inti yang lebih spesifik untuk tabel (misal: "data perbandingan X dan Y").', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 6. Refleksi Siswa
                    worksheetOutputContainer.appendChild(addElement('h2', 'Refleksi Diri Siswa', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    const reflectionList = document.createElement('ul');
                    reflectionList.className = 'list-none mb-4 text-base leading-relaxed';
                    
                    if (Array.isArray(parsedResponse.refleksiSiswa) && parsedResponse.refleksiSiswa.length > 0) {
                        parsedResponse.refleksiSiswa.forEach((q, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${index + 1}.</strong> ${q}<br>`;
                            addLine(li, 2);
                            reflectionList.appendChild(li);
                        });
                        worksheetOutputContainer.appendChild(reflectionList);
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian Refleksi Siswa ini mengajak siswa mengevaluasi pemahaman mereka. Anda bisa memberikan ide di kolom input "Refleksi Siswa" di atas.', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 7. Penilaian Diri (Self-Assessment)
                    worksheetOutputContainer.appendChild(addElement('h2', 'Penilaian Diri (Berikan tanda centang pada kolom yang sesuai)', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.penilaianDiri) && parsedResponse.penilaianDiri.length > 0) {
                        const selfAssessmentTable = document.createElement('table');
                        selfAssessmentTable.className = 'w-full border-collapse border border-gray-400 mb-4 text-base';

                        const saThead = document.createElement('thead');
                        const saHeaderRow = document.createElement('tr');
                        ["Pernyataan", "Ya", "Tidak"].forEach(headerText => {
                            const th = document.createElement('th');
                            th.className = 'border border-gray-300 p-2 text-left bg-gray-100';
                            if (headerText === "Ya" || headerText === "Tidak") {
                                th.classList.add('text-center');
                            }
                            th.textContent = headerText;
                            saHeaderRow.appendChild(th);
                        });
                        saThead.appendChild(saHeaderRow);
                        selfAssessmentTable.appendChild(saThead);

                        const saTbody = document.createElement('tbody');
                        parsedResponse.penilaianDiri.forEach(statement => {
                            const row = document.createElement('tr');
                            const tdStatement = document.createElement('td');
                            tdStatement.className = 'border border-gray-300 p-2';
                            tdStatement.textContent = statement;
                            row.appendChild(tdStatement);

                            const tdYes = document.createElement('td');
                            tdYes.className = 'border border-gray-300 p-2 text-center';
                            tdYes.textContent = 'â˜'; // Add empty checkbox
                            row.appendChild(tdYes);

                            const tdNo = document.createElement('td');
                            tdNo.className = 'border border-gray-300 p-2 text-center';
                            tdNo.textContent = 'â˜'; // Add empty checkbox
                            row.appendChild(tdNo);
                            saTbody.appendChild(row);
                        });
                        selfAssessmentTable.appendChild(saTbody);
                        worksheetOutputContainer.appendChild(selfAssessmentTable);
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian Penilaian Diri membantu siswa mengevaluasi pemahaman mereka sendiri. Anda bisa memberikan ide di kolom input "Penilaian Diri" di atas.', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 8. Kesimpulan & Tugas Tambahan (Opsional)
                    worksheetOutputContainer.appendChild(addElement('h2', 'Kesimpulan & Tugas Tambahan', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', parsedResponse.kesimpulan || 'Bagian Kesimpulan ini akan merangkum poin-poin penting dari LKPD. Anda bisa memberikan ide di kolom input "Kesimpulan" di atas.', 'mb-4 text-base leading-relaxed italic text-gray-500'));
                    
                    if (parsedResponse.tugasTambahan && parsedResponse.tugasTambahan.trim() !== '') {
                        worksheetOutputContainer.appendChild(addElement('p', '<strong>Tugas Tambahan:</strong> ' + parsedResponse.tugasTambahan, 'mb-4 text-base leading-relaxed'));
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', 'Bagian Tugas Tambahan ini dapat berisi PR atau tugas lanjutan. Anda bisa memberikan ide di kolom input "Tugas Tambahan" di atas.', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // BONUS: Ruang Catatan Bebas Siswa (Conditional)
                    if (ruangCatatanBebasStatus === 'ya') {
                        worksheetOutputContainer.appendChild(addElement('h2', 'Ruang Catatan Bebas Siswa', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                        worksheetOutputContainer.appendChild(addElement('p', parsedResponse.ruangCatatanBebas || 'Gunakan ruang ini untuk mencatat ide, pertanyaan, atau pemikiran lain terkait pembelajaran.', 'text-sm italic text-gray-600 mb-2'));
                        addLine(worksheetOutputContainer, 5);
                    }


                    displayNotificationMessage('Lembar Aktivitas Siswa berhasil dibuat!', false);

                } else {
                    displayNotificationMessage("Maaf, gagal menghasilkan konten Lembar Aktivitas. Struktur respons dari AI tidak sesuai atau kosong. Coba lagi atau sesuaikan input Anda.", true);
                    worksheetOutputContainer.innerHTML = `<p class="text-center text-gray-500 italic">Gagal membuat LKPD. Silakan coba lagi dengan input yang lebih jelas.</p>`;
                }
            } catch (error) {
                console.error('Error saat menghasilkan konten Lembar Aktivitas:', error);
                if (error.message.includes("Gagal mengurai respons JSON dari AI")) {
                    displayNotificationMessage(`${error.message}. Pastikan Kunci API Gemini Anda valid dan coba lagi.`, true);
                } else if (error.message.includes("Kesalahan API:")) {
                    displayNotificationMessage(`${error.message}. Pastikan Kunci API Anda valid dan memiliki kuota yang cukup.`, true);
                }
                else {
                    displayNotificationMessage(`Terjadi kesalahan tak terduga: ${error.message}. Pastikan semua bidang penting terisi dan koneksi internet stabil. Coba lagi.`, true);
                }
                worksheetOutputContainer.innerHTML = `<p class="text-center text-red-500 italic">Terjadi kesalahan: ${error.message}. Cek konsol browser (F12) untuk detail.</p>`;
            } finally {
                generateWorksheetBtn.disabled = false;
                generateWorksheetBtn.querySelector('span').textContent = 'Buat Lembar Aktivitas dengan AI';
            }
        }

        /**
         * Menyalin konten LKPD yang dihasilkan ke clipboard.
         */
        function copyGeneratedWorksheet() {
            const range = document.createRange();
            range.selectNodeContents(worksheetOutputContainer);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            displayNotificationMessage('Teks Lembar Aktivitas berhasil disalin ke clipboard!', false);
        }

        /**
         * Membersihkan semua bidang formulir dan area output LKPD.
         */
        function resetFormFields() {
            teacherNameInputElem.value = '';
            gradeInputElem.value = '';
            subjectInputElem.value = '';
            learningTopicInputElem.value = '';
            semesterInputElem.value = '';
            competenceGoalsInputElem.value = '';
            apersepsiInputElem.value = '';
            petunjukKerjaInputElem.value = '';
            jumlahSoalInputElem.value = '3';
            bentukSoalSelectElem.value = 'esai';
            levelSoalSelectElem.value = 'C4';
            kegiatanIntiPromptInputElem.value = '';
            refleksiSiswaInputElem.value = '';
            penilaianDiriInputElem.value = '';
            kesimpulanInputElem.value = '';
            tugasTambahanInputElem.value = '';
            ruangCatatanYaElem.checked = true;

            worksheetOutputContainer.innerHTML = '<p class="text-center text-gray-500 italic">LKPD yang dihasilkan AI akan muncul di sini setelah Anda mengklik "Buat Lembar Aktivitas dengan AI".</p>';
            document.querySelectorAll('.required-field').forEach(field => field.classList.remove('required-field'));
            displayNotificationMessage('Semua bidang formulir berhasil dibersihkan.', false);
        }

        // Inisialisasi utama setelah DOM dimuat sepenuhnya
        document.addEventListener('DOMContentLoaded', () => {
            generateWorksheetBtn.addEventListener('click', generateWorksheetContent);
            copyWorksheetBtn.addEventListener('click', copyGeneratedWorksheet);
            clearFormBtn.addEventListener('click', resetFormFields);
            
            const setupModalAndEventListeners = () => {
                const storedApiKey = localStorage.getItem('geminiApiKey');
                if (!storedApiKey || storedApiKey.trim() === '') {
                    geminiApiModal.classList.add('show');
                }
                modalApiInputElem.value = storedApiKey || '';

                saveApiBtn.addEventListener('click', storeApiKeyLocally);
                clearApiBtn.addEventListener('click', removeApiKeyLocally);
                closeApiModalBtn.addEventListener('click', () => {
                    geminiApiModal.classList.remove('show');
                });
                settingsControlBtn.addEventListener('click', () => {
                    geminiApiModal.classList.add('show');
                    modalApiInputElem.value = localStorage.getItem('geminiApiKey') || '';
                });
            };
            
            setupModalAndEventListeners();
        });
    </script>
</body>
</html>
