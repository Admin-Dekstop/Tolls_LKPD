<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asisten Pembuat Lembar Aktivitas Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk font Inter jika tersedia, fallback ke sans-serif */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-smoothing: grayscale;
            background-color: #e6f7ff; /* Warna latar belakang biru pastel yang berbeda */
            color: #333; /* Warna teks dasar */
        }
        /* Mengatur agar area output LKPD bisa di-scroll dan terlihat rapi */
        #worksheetOutputContainer {
            min-height: 400px; /* Tinggi minimal untuk area output */
            font-family: 'Arial', sans-serif; /* Font umum untuk dokumen */
            font-size: 1rem; /* Ukuran font dasar */
            line-height: 1.6; /* Spasi baris untuk keterbacaan */
            overflow-y: auto; /* Agar bisa discroll jika konten panjang */
        }
        #worksheetOutputContainer h1, #worksheetOutputContainer h2 {
            font-weight: bold;
            margin-bottom: 0.75rem;
        }
        #worksheetOutputContainer h1 {
            font-size: 1.5rem; /* Ukuran untuk judul utama LKPD */
            text-align: center;
            color: #1a202c; /* Hampir hitam */
        }
        #worksheetOutputContainer h2 {
            font-size: 1.25rem; /* Ukuran untuk sub-judul bagian */
            color: #2c5282; /* Biru tua */
            margin-top: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.25rem;
        }
        #worksheetOutputContainer p, #worksheetOutputContainer ul, #worksheetOutputContainer ol, #worksheetOutputContainer table {
            margin-bottom: 1rem;
        }
        #worksheetOutputContainer ul, #worksheetOutputContainer ol {
            padding-left: 1.5rem;
        }
        #worksheetOutputContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        #worksheetOutputContainer th, #worksheetOutputContainer td {
            border: 1px solid #cbd5e0;
            padding: 0.75rem;
            text-align: left;
        }
        #worksheetOutputContainer th {
            background-color: #f0f4f8;
            font-weight: 600;
        }

        /* Styling untuk mode cetak */
        @media print {
            body {
                background-color: white; /* Hapus background di mode cetak */
                margin: 0; /* Hapus margin body */
                padding: 0;
                font-size: 10pt; /* Ukuran font lebih kecil untuk cetak */
                line-height: 1.4;
            }
            .hide-on-print {
                display: none !important; /* Sembunyikan elemen yang tidak perlu dicetak */
            }
            .printable-area {
                width: 21cm; /* Lebar A4 */
                height: 29.7cm; /* Tinggi A4 */
                margin: 0.5cm auto; /* Margin atas/bawah 0.5cm, tengah horizontal */
                padding: 2.5cm; /* Margin 2.5 cm di semua sisi */
                box-sizing: border-box; /* Pastikan padding termasuk dalam lebar/tinggi */
                font-family: 'Times New Roman', serif; /* Font untuk cetak */
            }
            .printable-area h1 {
                font-size: 18pt;
                margin-bottom: 1em;
            }
            .printable-area h2 {
                font-size: 14pt;
                margin-top: 1.5em;
                margin-bottom: 0.5em;
                border-bottom: 1px solid #ccc;
                padding-bottom: 0.2em;
            }
            .printable-area p, .printable-area ul, .printable-area ol, .printable-area table {
                margin-bottom: 0.8em;
            }
            .printable-area ul, .printable-area ol {
                padding-left: 1.2em;
            }
        }

        /* Modal Styles */
        .api-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Sedikit lebih gelap */
            backdrop-filter: blur(6px); /* Sedikit lebih blur */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .api-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content-card {
            background-color: #ffffff;
            padding: 2.5rem; /* Padding sedikit lebih besar */
            border-radius: 1rem; /* Sudut lebih membulat */
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3); /* Bayangan lebih tebal */
            width: 95%;
            max-width: 550px; /* Lebar maksimum sedikit lebih besar */
            text-align: center;
            transform: translateY(-30px); /* Efek masuk sedikit lebih jauh */
            transition: transform 0.3s ease-in-out;
        }
        .api-modal-overlay.show .modal-content-card {
            transform: translateY(0);
        }
        .modal-content-card h2 {
            font-size: 1.75rem; /* Ukuran font lebih besar */
            font-weight: 800; /* Lebih tebal */
            color: #4f46e5; /* Indigo-600 */
            margin-bottom: 1.25rem;
        }
        .modal-content-card p {
            color: #6b7280; /* Gray-600 */
            margin-bottom: 1.75rem;
        }
        .modal-content-card input[type="password"] {
            margin-bottom: 1.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.625rem; /* Sedikit lebih membulat */
            padding: 0.875rem 1.25rem; /* Padding lebih besar */
            width: 100%;
            font-size: 1rem;
        }
        .modal-actions-group {
            display: flex;
            gap: 1.25rem; /* Jarak antar tombol lebih besar */
            justify-content: center;
            flex-wrap: wrap;
        }
        .modal-actions-group button {
            flex-grow: 1;
            padding: 0.875rem 1.75rem; /* Padding lebih besar */
            border-radius: 0.625rem;
            font-weight: 700; /* Lebih tebal */
            cursor: pointer;
            transition: all 0.2s ease-in-out; /* Transisi untuk semua properti */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Bayangan tombol */
        }
        .modal-actions-group .btn-action-save {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
        }
        .modal-actions-group .btn-action-save:hover {
            background-color: #4338ca; /* Indigo-700 */
            transform: translateY(-2px); /* Efek angkat */
        }
        .modal-actions-group .btn-action-clear {
            background-color: #ef4444; /* Rose-500 */
            color: white;
        }
        .modal-actions-group .btn-action-clear:hover {
            background-color: #dc2626; /* Rose-600 */
            transform: translateY(-2px);
        }
        .modal-actions-group .btn-action-close {
            background-color: #6b7280; /* Slate-500 */
            color: white;
        }
        .modal-actions-group .btn-action-close:hover {
            background-color: #4b5563; /* Slate-600 */
            transform: translateY(-2px);
        }

        /* Settings Button Styles */
        #settingsControlBtn {
            position: static;
            width: fit-content;
            height: auto;
            padding: 0.625rem 1.25rem;
            margin-top: 1.5rem;
            margin-left: auto;
            margin-right: auto;
            display: flex;
            align-items: center;
            gap: 0.625rem;
            background-color: #e0f2fe;
            color: #2563eb;
            border: 1px solid #93c5fd;
            border-radius: 0.625rem;
            font-size: 0.9rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            z-index: 10;
            cursor: pointer;
        }
        #settingsControlBtn:hover {
            background-color: #bfdbfe;
            color: #1e40af;
            transform: scale(1.03);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        @media (min-width: 768px) {
            #settingsControlBtn {
                position: fixed;
                top: 1.5rem;
                right: 1.5rem;
                width: 3rem;
                height: 3rem;
                padding: 0.5rem;
                background-color: #4f46e5;
                color: white;
                border: none;
                border-radius: 50%;
                justify-content: center;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
                z-index: 1002;
            }
            #settingsControlBtn:hover {
                background-color: #4338ca;
                transform: scale(1.08);
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            }
        }

        /* Notification Message Box */
        .notification-message {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            max-width: 90%;
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.95rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .notification-message.show {
            opacity: 1;
            visibility: visible;
        }
        .notification-success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .notification-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .required-field {
            border-color: #ef4444 !important; /* Merah untuk field wajib yang kosong */
        }
        .animate-pulse-light {
            animation: pulse-light 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-light {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="p-5 md:p-10">
    <div class="max-w-5xl mx-auto bg-white p-8 md:p-10 rounded-2xl shadow-xl border border-indigo-200 relative">
        <button id="settingsControlBtn" class="hide-on-print">
            <svg class="w-6 h-6 hidden md:block" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 15.375a3.375 3.375 0 100-6.75 3.375 3.375 0 000 6.75z" />
                <path fill-rule="evenodd" d="M10.707 2.293a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.478.478a.75.75 0 001.06 0l.478-.478a1 1 0 011.414 0l.293.293a1 1 0 010 1.414l-.478.478a.75.75 0 000 1.06l.478.478a1 1 0 010 1.414l-.293.293a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.478-.478a.75.75 0 00-1.06 0l-.478.478a1 1 0 01-1.414 0l-.293-.293a1 1 0 010-1.414l.478-.478a.75.75 0 000-1.06l-.478-.478a1 1 0 010-1.414l.293-.293zM12 18a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" />
            </svg>
            <span class="md:hidden">Kelola Kunci API</span>
        </button>
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-indigo-800 mb-7">Asisten Pembuat Lembar Aktivitas Siswa</h1>
        <p class="text-center text-gray-700 mb-9">Isi detail di bawah untuk menghasilkan Lembar Aktivitas siswa (LKPD) yang siap cetak dan berbasis teks.</p>

        <div class="hide-on-print space-y-6 mb-12">
            <div class="p-6 border border-indigo-300 rounded-xl bg-indigo-50">
                <p class="text-lg font-bold text-indigo-800 mb-4">✅ Data Guru & Informasi LKPD</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-4">
                    <div>
                        <label for="teacherNameInput" class="block text-sm font-medium text-gray-700">Nama Guru <span class="text-red-500">*</span></label>
                        <input type="text" id="teacherNameInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Bpk. Andi Susanto, M.Pd.">
                    </div>
                    <div>
                        <label for="gradeInput" class="block text-sm font-medium text-gray-700">Kelas <span class="text-red-500">*</span></label>
                        <input type="text" id="gradeInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: X IPA 1 / 7">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label for="subjectInput" class="block text-sm font-medium text-gray-700">Mata Pelajaran <span class="text-red-500">*</span></label>
                        <input type="text" id="subjectInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Fisika / Matematika">
                    </div>
                    <div>
                        <label for="learningTopicInput" class="block text-sm font-medium text-gray-700">Materi Pokok <span class="text-red-500">*</span></label>
                        <input type="text" id="learningTopicInput" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base" placeholder="Contoh: Hukum Newton tentang Gerak / Aljabar Linier">
                    </div>
                </div>
            </div>

            <div class="p-6 border border-teal-300 rounded-xl bg-teal-50">
                <label for="competenceGoalsInput" class="block text-lg font-bold text-teal-800 mb-3">Kompetensi Dasar / Tujuan Pembelajaran <span class="text-red-500">*</span></label>
                <p class="text-sm text-gray-600 mb-3">Sebutkan Kompetensi Dasar atau Tujuan Pembelajaran yang ingin dicapai. AI akan mengubahnya menjadi Tujuan Pembelajaran yang berorientasi siswa.</p>
                <textarea id="competenceGoalsInput" rows="4" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-base" placeholder="Contoh:&#10;- Menganalisis pengaruh gaya terhadap percepatan benda&#10;- Mengidentifikasi jenis-jenis gaya berdasarkan kontak/non-kontak"></textarea>
            </div>

            <div class="p-6 border border-purple-300 rounded-xl bg-purple-50">
                <label for="apersepsiInput" class="block text-lg font-bold text-purple-800 mb-3">Ide Pengantar / Apersepsi (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan ide atau pertanyaan pemantik terkait kehidupan sehari-hari untuk memulai LKPD. AI akan mengembangkannya.</p>
                <textarea id="apersepsiInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-base" placeholder="Contoh:&#10;Pernahkah kamu memperhatikan mengapa bola yang ditendang akhirnya berhenti?&#10;Bagaimana gaya bekerja dalam olahraga tim?"></textarea>
            </div>

            <div class="p-6 border border-orange-300 rounded-xl bg-orange-50">
                <label for="petunjukKerjaInput" class="block text-lg font-bold text-orange-800 mb-3">Petunjuk Kerja Umum (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Sebutkan poin-poin instruksi umum yang ingin siswa ikuti. AI akan menyusunnya menjadi petunjuk yang sistematis.</p>
                <textarea id="petunjukKerjaInput" rows="3" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500 text-base" placeholder="Contoh:&#10;- Baca materi ini dengan seksama.&#10;- Diskusikan dengan kelompokmu.&#10;- Presentasikan hasil diskusi."></textarea>
            </div>

            <div class="p-6 border border-red-300 rounded-xl bg-red-50">
                <label for="kegiatanIntiScenarioInput" class="block text-lg font-bold text-red-800 mb-3">Skenario/Poin untuk Kegiatan Inti (Opsional)</label>
                <p class="text-sm text-gray-600 mb-3">Berikan beberapa skenario, konsep, atau poin yang ingin dijadikan dasar pertanyaan terbuka dan aktivitas. Setiap poin satu baris.</p>
                <textarea id="kegiatanIntiScenarioInput" rows="5" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 text-base" placeholder="Contoh:&#10;- Bola menggelinding di lantai lalu berhenti.&#10;- Dua orang mendorong meja yang sama dari arah berlawanan.&#10;- Mengapa roket bisa terbang ke luar angkasa?"></textarea>
            </div>

            <div class="p-6 border border-gray-300 rounded-xl bg-gray-50">
                <label for="questionDifficulty" class="block text-lg font-bold text-gray-800 mb-3">Level Kesulitan Soal (untuk Kegiatan Inti)</label>
                <p class="text-sm text-gray-600 mb-3">Pilih level kesulitan untuk pertanyaan dan aktivitas yang akan dihasilkan AI.</p>
                <select id="questionDifficulty" class="mt-1 block w-full px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-base">
                    <option value="dasar">Dasar (C1-C2)</option>
                    <option value="menengah" selected>Menengah (C3-C4, Analisis)</option>
                    <option value="tinggi">Tinggi (C5-C6, Evaluasi/Kreasi - HOTS)</option>
                </select>
            </div>
            
            <button id="generateWorksheetBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-5 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:scale-105 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>Buat Lembar Aktivitas dengan AI</span>
            </button>
        </div>

        <div class="mt-10 printable-area">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-5 text-center hide-on-print">Hasil Lembar Aktivitas Anda</h2>
            <div id="worksheetOutputContainer" class="w-full p-5 border border-teal-300 rounded-lg bg-teal-50 text-gray-800 shadow-inner">
                <p class="text-center text-gray-500 italic">LKPD yang dihasilkan AI akan muncul di sini setelah Anda mengklik "Buat Lembar Aktivitas dengan AI".</p>
            </div>

            <div class="mt-5 flex justify-center hide-on-print flex-wrap gap-3">
                <button id="copyWorksheetBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zM5 9.3V7a1 1 0 011-1h8a1 1 0 011 1v2.3l2.353 2.354a1 1 0 000-1.414l-4.95-4.95a1 1 0 00-1.414 0L3.646 9.3a1 1 0 000 1.414l4.95 4.95a1 1 0 001.414 0L17 10.3V13a2 2 0 01-2 2H6a2 2 0 01-2-2v-3.7z" />
                    </svg>
                    <span>Salin Teks</span>
                </button>
                <button id="clearFormBtn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 px-5 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                    <span>Bersihkan Formulir</span>
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-5 text-center hide-on-print">
                Salin teks di atas, lalu tempel ke aplikasi pengolah kata (MS Word/Google Docs) untuk penyesuaian tata letak dan pencetakan optimal.
            </p>
        </div>
    </div>

    <div id="geminiApiModal" class="api-modal-overlay">
        <div class="modal-content-card">
            <h2>Konfigurasi Kunci API Gemini</h2>
            <p>
                Untuk memanfaatkan kapabilitas AI, Anda perlu memasukkan Kunci API Gemini Anda.
                Kunci ini akan disimpan secara lokal di browser Anda dan tidak akan dikirimkan ke server eksternal.
            </p>
            <input type="password" id="modalApiInput" placeholder="Contoh: AIzaSyC_..." class="focus:ring-2 focus:ring-indigo-300">
            <div class="modal-actions-group">
                <button id="saveApiBtn" class="btn-action-save">Simpan Kunci</button>
                <button id="clearApiBtn" class="btn-action-clear">Hapus Kunci</button>
                <button id="closeApiModalBtn" class="btn-action-close">Tutup</button>
            </div>
            <p class="mt-5 text-sm text-gray-500">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="text-indigo-500 hover:underline">Dapatkan Kunci API Gemini Anda di sini</a>
            </p>
        </div>
    </div>

    <script>
        // Mendapatkan referensi elemen-elemen DOM
        const teacherNameInputElem = document.getElementById('teacherNameInput');
        const gradeInputElem = document.getElementById('gradeInput');
        const subjectInputElem = document.getElementById('subjectInput');
        const learningTopicInputElem = document.getElementById('learningTopicInput');
        const competenceGoalsInputElem = document.getElementById('competenceGoalsInput');
        const apersepsiInputElem = document.getElementById('apersepsiInput');
        const petunjukKerjaInputElem = document.getElementById('petunjukKerjaInput');
        const kegiatanIntiScenarioInputElem = document.getElementById('kegiatanIntiScenarioInput');
        const questionDifficultySelectElem = document.getElementById('questionDifficulty');

        const worksheetOutputContainer = document.getElementById('worksheetOutputContainer'); // Ini sekarang DIV
        const generateWorksheetBtn = document.getElementById('generateWorksheetBtn');
        const copyWorksheetBtn = document.getElementById('copyWorksheetBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        const geminiApiModal = document.getElementById('geminiApiModal');
        const modalApiInputElem = document.getElementById('modalApiInput');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const clearApiBtn = document.getElementById('clearApiBtn');
        const closeApiModalBtn = document.getElementById('closeApiModalBtn');
        const settingsControlBtn = document.getElementById('settingsControlBtn');

        // Fungsi untuk menampilkan pesan notifikasi temporer
        function displayNotificationMessage(message, isError = false) {
            const container = document.querySelector('.max-w-5xl.mx-auto');
            let notificationDiv = container.querySelector('.notification-message');

            if (!notificationDiv) {
                notificationDiv = document.createElement('div');
                notificationDiv.className = `notification-message p-3 rounded-md mb-4 text-center text-sm absolute top-4 left-1/2 -translate-x-1/2 w-3/4 z-20 shadow-lg`;
                container.insertBefore(notificationDiv, container.firstChild);
            }

            notificationDiv.textContent = message;
            notificationDiv.classList.remove('notification-success', 'notification-error', 'hidden', 'show');
            notificationDiv.classList.add(isError ? 'notification-error' : 'notification-success');
            notificationDiv.classList.add('show');

            setTimeout(() => {
                notificationDiv.classList.remove('show');
                setTimeout(() => notificationDiv.classList.add('hidden'), 300);
            }, 3000);
        }

        // Fungsi untuk menyimpan Kunci API Gemini ke localStorage
        function storeApiKeyLocally() {
            const apiKey = modalApiInputElem.value.trim();
            if (apiKey) {
                localStorage.setItem('geminiApiKey', apiKey);
                geminiApiModal.classList.remove('show');
                displayNotificationMessage('Kunci API Gemini berhasil disimpan.', false);
            } else {
                displayNotificationMessage('Kunci API Gemini tidak boleh kosong.', true);
            }
        }

        // Fungsi untuk menghapus Kunci API Gemini dari localStorage
        function removeApiKeyLocally() {
            localStorage.removeItem('geminiApiKey');
            modalApiInputElem.value = '';
            displayNotificationMessage('Kunci API Gemini telah dihapus.', false);
        }

        // Fungsi untuk validasi input
        function validateInputs() {
            let isValid = true;
            const requiredFields = [
                teacherNameInputElem,
                gradeInputElem,
                subjectInputElem,
                learningTopicInputElem,
                competenceGoalsInputElem
            ];

            requiredFields.forEach(field => {
                if (field.value.trim() === '') {
                    field.classList.add('required-field');
                    isValid = false;
                } else {
                    field.classList.remove('required-field');
                }
            });

            if (!isValid) {
                displayNotificationMessage("Mohon lengkapi semua bidang yang ditandai (*) sebelum membuat LKPD.", true);
            }
            return isValid;
        }

        // Fungsi utama untuk menghasilkan konten Lembar Aktivitas Siswa dengan AI
        const generateWorksheetContent = async () => {
            const apiKey = localStorage.getItem('geminiApiKey');

            if (!apiKey || apiKey.trim() === '') {
                displayNotificationMessage('Kunci API Gemini diperlukan untuk membuat Lembar Aktivitas. Silakan masukkan di pengaturan.', true);
                geminiApiModal.classList.add('show');
                modalApiInputElem.value = '';
                return;
            }

            if (!validateInputs()) {
                return;
            }

            // Dapatkan semua nilai input
            const teacherName = teacherNameInputElem.value.trim();
            const grade = gradeInputElem.value.trim();
            const subject = subjectInputElem.value.trim();
            const learningTopic = learningTopicInputElem.value.trim();
            const competenceGoals = competenceGoalsInputElem.value.trim();
            const apersepsiIdea = apersepsiInputElem.value.trim();
            const petunjukKerjaGeneral = petunjukKerjaInputElem.value.trim();
            const kegiatanIntiScenarios = kegiatanIntiScenarioInputElem.value.split('\n').map(s => s.trim()).filter(Boolean);
            const questionDifficulty = questionDifficultySelectElem.value.trim();

            worksheetOutputContainer.innerHTML = `<p class="text-center text-gray-500 italic animate-pulse-light">Menyiapkan konten Lembar Aktivitas cerdas dengan AI... Harap bersabar, proses ini mungkin membutuhkan waktu beberapa detik.</p>`;
            generateWorksheetBtn.disabled = true;
            generateWorksheetBtn.querySelector('span').textContent = 'Memproses...';

            try {
                // Prompt untuk Gemini API
                const aiPrompt = `
                Sebagai Asisten AI Pendidikan, tugas Anda adalah membantu guru membuat LKPD (Lembar Kerja Peserta Didik) yang siap cetak, berbasis teks, tanpa gambar, tanpa digitalisasi, dan tanpa ikon/QR code, namun tetap efektif secara pedagogis.

                Format LKPD harus ringkas, jelas, dan memuat elemen penting untuk pembelajaran aktif dan reflektif.
                Output Anda harus dalam format JSON sesuai skema yang diberikan. **PASTIKAN SEMUA PROPERTI JSON ADA, walaupun nilainya kosong, string kosong, atau array kosong jika tidak ada kontennya.** Jangan hilangkan properti apa pun.

                DATA GURU:
                - Nama Guru: "${teacherName}"
                - Kelas: "${grade}"
                - Mata Pelajaran: "${subject}"
                - Materi Pokok: "${learningTopic}"
                - Kompetensi Dasar/Tujuan Pembelajaran (yang ingin diubah menjadi bahasa siswa): "${competenceGoals}"

                IDE GURU (Jika ada, KEMBANGKAN dan detailkan ini. Jika kosong, buat konten yang relevan dengan Mata Pelajaran dan Materi Pokok):
                - Ide Pengantar/Apersepsi: "${apersepsiIdea || 'kosong'}"
                - Petunjuk Kerja Umum: "${petunjukKerjaGeneral || 'kosong'}"
                - Skenario/Poin untuk Kegiatan Inti: ${kegiatanIntiScenarios.length > 0 ? JSON.stringify(kegiatanIntiScenarios) : 'kosong'}
                - Level Kesulitan Soal untuk Kegiatan Inti: "${questionDifficulty}"

                STRUKTUR OUTPUT JSON YANG HARUS ANDA HASILKAN:

                {
                    "identitasLKPD": {
                        "mataPelajaran": "[Mata Pelajaran dari DATA GURU]",
                        "kelas": "[Kelas dari DATA GURU]",
                        "semester": "[Tebak Semester, misal: Ganjil/Genap, berdasarkan konteks umum pendidikan di Indonesia]",
                        "materiPokok": "[Materi Pokok dari DATA GURU]",
                        "namaGuru": "[Nama Guru dari DATA GURU]"
                    },
                    "tujuanPembelajaran": [
                        "- [Tujuan 1 ditulis dalam bahasa siswa, aktif dan komunikatif, DARI Kompetensi Dasar/Tujuan Pembelajaran GURU]",
                        "- [Tujuan 2]",
                        "- [Tujuan 3, dst, minimal 3 tujuan]"
                    ],
                    "pengantarApersepsi": "[Paragraf pengantar singkat, 2-4 kalimat. Jika 'Ide Pengantar/Apersepsi' dari GURU KOSONG, buat pertanyaan pemantik atau reflektif umum terkait kehidupan sehari-hari yang relevan dengan Materi Pokok. Jika ada ide, KEMBANGKAN secara mendalam]",
                    "petunjukKerja": [
                        "1. [Langkah 1 yang sistematis dan jelas. Jika 'Petunjuk Kerja Umum' dari GURU KOSONG, buat langkah-langkah standar untuk LKPD (misal: baca, diskusi, catat, presentasi). Jika ada ide, KEMBANGKAN dan urutkan secara sistematis]",
                        "2. [Langkah 2]",
                        "3. [Langkah 3]",
                        "4. [Langkah 4, dst, minimal 4 langkah]"
                    ],
                    "kegiatanInti": {
                        "instruksiUmum": "[Instruksi umum singkat untuk bagian Kegiatan Inti, 1-2 kalimat. Buat ini relevan dengan Materi Pokok]",
                        "pertanyaanBertingkat": [
                            "1. [Pertanyaan terbuka dan bertingkat (C1-C4/HOTS) terkait Materi Pokok, disesuaikan dengan 'Level Kesulitan Soal' GURU dan KEMBANGKAN dari 'Skenario/Poin untuk Kegiatan Inti' GURU jika ada. Buat minimal 4-6 pertanyaan.]",
                            "2. [Pertanyaan 2]",
                            "3. [Pertanyaan 3]",
                            "4. [Pertanyaan 4]"
                        ],
                        "tabelObservasi": [ // Selalu hasilkan array ini. Jika 'Skenario/Poin untuk Kegiatan Inti' GURU sangat mendukung format observasi/kategorisasi, isi tabel ini dengan data relevan. Jika tidak, hasilkan array kosong [].
                            {"No.": "1.", "Skenario/Poin": "[Skenario 1 dari input guru atau AI]", "Analisis": "", "Kesimpulan Singkat": ""},
                            {"No.": "2.", "Skenario/Poin": "[Skenario 2 dari input guru atau AI]", "Analisis": "", "Kesimpulan Singkat": ""}
                        ]
                    },
                    "refleksiSiswa": {
                        "pertanyaan1": "Apa yang saya pelajari hari ini?",
                        "pertanyaan2": "Bagian mana yang paling saya pahami atau sulit?",
                        "pertanyaan3": "Apa yang ingin saya tanyakan lebih lanjut terkait materi ini?"
                    },
                    "penilaianDiri": [ // Buat minimal 3-5 pernyataan yang relevan dengan Tujuan Pembelajaran dan Materi Pokok.
                        "[Pernyataan 1 untuk self-assessment, contoh: 'Saya memahami konsep dasar Hukum Newton.']",
                        "[Pernyataan 2, contoh: 'Saya mampu menganalisis permasalahan terkait gaya dan gerak.']",
                        "[Pernyataan 3]"
                    ],
                    "kesimpulanTugasTambahan": "[Ringkasan poin penting dari LKPD dan/atau PR ringan/tugas lanjutan jika relevan, 2-4 kalimat. KEMBANGKAN ini berdasarkan Materi Pokok]",
                    "ruangCatatanBebas": "[Pernyataan singkat untuk ruang catatan bebas siswa, 1-2 kalimat. Misalnya: 'Gunakan ruang ini untuk mencatat ide, pertanyaan, atau pemikiran lain terkait pembelajaran.']"
                }

                KETENTUAN TAMBAHAN UNTUK SEMUA TEKS YANG DIHASILKAN:
                - TIDAK mengandung gambar, ikon, QR code, atau media digital lainnya.
                - Gunakan bahasa Indonesia yang ramah siswa, formal, dan sesuai level berpikir siswa SMA/sederajat.
                - Output harus berupa teks murni yang bisa langsung dicetak.
                - Pastikan output JSON Anda bersih, tanpa karakter markdown di dalam string, kecuali untuk list item yang diawali tanda hubung.
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: aiPrompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "identitasLKPD": {
                                    type: "OBJECT",
                                    properties: {
                                        "mataPelajaran": { "type": "STRING" },
                                        "kelas": { "type": "STRING" },
                                        "semester": { "type": "STRING" },
                                        "materiPokok": { "type": "STRING" },
                                        "namaGuru": { "type": "STRING" }
                                    },
                                    "propertyOrdering": ["mataPelajaran", "kelas", "semester", "materiPokok", "namaGuru"]
                                },
                                "tujuanPembelajaran": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "pengantarApersepsi": { "type": "STRING" },
                                "petunjukKerja": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "kegiatanInti": {
                                    type: "OBJECT",
                                    properties: {
                                        "instruksiUmum": { "type": "STRING" },
                                        "pertanyaanBertingkat": { "type": "ARRAY", "items": { "type": "STRING" } },
                                        "tabelObservasi": {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    "No.": { "type": "STRING" },
                                                    "Skenario/Poin": { "type": "STRING" },
                                                    "Analisis": { "type": "STRING" },
                                                    "Kesimpulan Singkat": { "type": "STRING" }
                                                }
                                            }
                                        }
                                    }
                                },
                                "refleksiSiswa": {
                                    type: "OBJECT",
                                    properties: {
                                        "pertanyaan1": { "type": "STRING" },
                                        "pertanyaan2": { "type": "STRING" },
                                        "pertanyaan3": { "type": "STRING" }
                                    }
                                },
                                "penilaianDiri": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "kesimpulanTugasTambahan": { "type": "STRING" },
                                "ruangCatatanBebas": { "type": "STRING" }
                            }
                        }
                    }
                };

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Kesalahan API: ${response.status} - ${errorData.error.message || 'Kesalahan tak dikenal'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {

                    const jsonString = result.candidates[0].content.parts[0].text;
                    // Hapus backticks dan kata 'json' jika AI mengembalikan dalam format code block
                    const cleanedJsonString = jsonString.replace(/^```json\s*|```\s*$/g, '').trim();

                    console.log("Respons JSON mentah dari Gemini:", cleanedJsonString); // Untuk debugging

                    let parsedResponse;
                    try {
                        parsedResponse = JSON.parse(cleanedJsonString);
                    } catch (e) {
                        throw new Error(`Gagal mengurai respons JSON dari AI. Respons tidak valid: ${e.message}. Respons mentah: ${cleanedJsonString.substring(0, 200)}...`);
                    }
                    console.log("Respons JSON yang diurai:", parsedResponse); // Untuk debugging

                    // --- Mulai membangun HTML Lembar Aktivitas Siswa ---
                    worksheetOutputContainer.innerHTML = ''; // Bersihkan konten sebelumnya

                    const addElement = (tag, content, className = '') => {
                        const elem = document.createElement(tag);
                        elem.className = className;
                        if (typeof content === 'string') {
                            elem.innerHTML = content.replace(/\n/g, '<br>'); // Handle newlines in string content
                        } else if (Array.isArray(content)) {
                            content.forEach(item => {
                                const li = document.createElement('li');
                                li.innerHTML = item.replace(/^- /, ''); // Remove hyphen for list items
                                elem.appendChild(li);
                            });
                        }
                        return elem;
                    };

                    const addLine = (container, count = 1) => {
                        for (let i = 0; i < count; i++) {
                            const line = document.createElement('p');
                            line.className = 'text-sm text-gray-700 leading-tight';
                            line.textContent = '........................................................................................................................................................';
                            container.appendChild(line);
                        }
                    };

                    // Defensif check for main sections
                    const identitasLKPD = parsedResponse.identitasLKPD || {};
                    const kegiatanInti = parsedResponse.kegiatanInti || {};
                    const refleksiSiswa = parsedResponse.refleksiSiswa || {};


                    // Judul Utama LKPD
                    worksheetOutputContainer.appendChild(addElement('h1', 'LEMBAR KERJA PESERTA DIDIK', 'text-xl font-bold text-center mb-4'));
                    worksheetOutputContainer.appendChild(document.createElement('hr')); // Garis pemisah

                    // 1. Identitas LKPD
                    worksheetOutputContainer.appendChild(addElement('h2', 'Identitas LKPD', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    const identitasDiv = addElement('div', '', 'mb-4 text-base');
                    identitasDiv.innerHTML = `
                        <p><strong>Mata Pelajaran:</strong> ${identitasLKPD.mataPelajaran || '-'}</p>
                        <p><strong>Kelas/Semester:</strong> ${identitasLKPD.kelas || '-'} / ${identitasLKPD.semester || '-'}</p>
                        <p><strong>Materi Pokok:</strong> ${identitasLKPD.materiPokok || '-'}</p>
                        <p><strong>Nama Guru:</strong> ${identitasLKPD.namaGuru || '-'}</p>
                    `;
                    worksheetOutputContainer.appendChild(identitasDiv);
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 2. Tujuan Pembelajaran
                    worksheetOutputContainer.appendChild(addElement('h2', 'Tujuan Pembelajaran', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.tujuanPembelajaran) && parsedResponse.tujuanPembelajaran.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('ul', parsedResponse.tujuanPembelajaran, 'list-disc list-inside mb-4 text-base leading-relaxed'));
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Tujuan Pembelajaran belum dihasilkan. Pastikan Kompetensi Dasar/Tujuan Pembelajaran diisi.]', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 3. Pengantar / Apersepsi
                    worksheetOutputContainer.appendChild(addElement('h2', 'Pengantar', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', parsedResponse.pengantarApersepsi || '[Pengantar/Apersepsi belum dihasilkan. Anda bisa memberikan ide di kolom yang tersedia.]', 'mb-4 text-base leading-relaxed'));
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 4. Petunjuk Kerja
                    worksheetOutputContainer.appendChild(addElement('h2', 'Petunjuk Kerja', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.petunjukKerja) && parsedResponse.petunjukKerja.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('ol', parsedResponse.petunjukKerja, 'list-decimal list-inside mb-4 text-base leading-relaxed'));
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Petunjuk Kerja belum dihasilkan. Anda bisa memberikan ide di kolom yang tersedia.]', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 5. Kegiatan Inti
                    worksheetOutputContainer.appendChild(addElement('h2', 'Kegiatan Inti', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', kegiatanInti.instruksiUmum || '[Instruksi umum kegiatan inti belum dihasilkan.]', 'mb-4 text-base leading-relaxed'));

                    // Pertanyaan Bertingkat
                    if (Array.isArray(kegiatanInti.pertanyaanBertingkat) && kegiatanInti.pertanyaanBertingkat.length > 0) {
                        worksheetOutputContainer.appendChild(addElement('p', 'Jawablah pertanyaan-pertanyaan berikut dengan berdiskusi:', 'font-medium mb-2 text-base'));
                        const qList = document.createElement('ol');
                        qList.className = 'list-decimal list-inside ml-4 mb-4 text-base leading-relaxed';
                        kegiatanInti.pertanyaanBertingkat.forEach(q => {
                            const li = document.createElement('li');
                            li.innerHTML = `${q.replace(/^\d+\.\s*/, '')}<br>`; // Remove numbering if AI includes it
                            addLine(li, 2); // 2 garis kosong untuk jawaban
                            qList.appendChild(li);
                        });
                        worksheetOutputContainer.appendChild(qList);
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Pertanyaan bertingkat belum dihasilkan. Coba berikan Skenario/Poin untuk Kegiatan Inti.]', 'italic text-gray-500'));
                    }

                    // Tabel Observasi (jika ada dan relevan)
                    if (Array.isArray(kegiatanInti.tabelObservasi) && kegiatanInti.tabelObservasi.length > 0) {
                        // Pastikan tabelObservasi memiliki setidaknya satu baris dengan data, bukan hanya baris kosong dari skema
                        const hasRealTableData = kegiatanInti.tabelObservasi.some(row =>
                            Object.values(row).some(val => val && val.trim() !== '' && val !== '1.')
                        );

                        if (hasRealTableData) {
                            worksheetOutputContainer.appendChild(addElement('p', 'Lengkapi tabel observasi di bawah ini:', 'font-medium mb-2 text-base'));
                            const table = document.createElement('table');
                            table.className = 'w-full border-collapse border border-gray-400 mb-4 text-base';

                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            ["No.", "Skenario/Poin", "Analisis", "Kesimpulan Singkat"].forEach(headerText => {
                                const th = document.createElement('th');
                                th.className = 'border border-gray-300 p-2 text-left bg-gray-100';
                                th.textContent = headerText;
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            const tbody = document.createElement('tbody');
                            kegiatanInti.tabelObservasi.forEach(rowData => {
                                const row = document.createElement('tr');
                                ["No.", "Skenario/Poin", "Analisis", "Kesimpulan Singkat"].forEach(key => {
                                    const td = document.createElement('td');
                                    td.className = 'border border-gray-300 p-2';
                                    td.textContent = rowData[key] || '';
                                    if (key === "Analisis" || key === "Kesimpulan Singkat") {
                                        addLine(td, 2); // Tambah garis untuk jawaban di kolom ini
                                    }
                                    row.appendChild(td);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            worksheetOutputContainer.appendChild(table);
                        } else {
                            worksheetOutputContainer.appendChild(addElement('p', '[Tabel observasi tidak dihasilkan karena skenario input tidak mendukung format ini.]', 'italic text-gray-500'));
                        }
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Tabel observasi tidak dihasilkan karena skenario input tidak mendukung format ini.]', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 6. Refleksi Siswa
                    worksheetOutputContainer.appendChild(addElement('h2', 'Refleksi Diri Siswa', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    const reflectionList = document.createElement('ul');
                    reflectionList.className = 'list-none mb-4 text-base leading-relaxed';
                    const reflectionQuestions = [
                        refleksiSiswa.pertanyaan1,
                        refleksiSiswa.pertanyaan2,
                        refleksiSiswa.pertanyaan3
                    ].filter(Boolean); // Filter undefined/null

                    if (reflectionQuestions.length > 0) {
                        reflectionQuestions.forEach((q, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${index + 1}.</strong> ${q}<br>`;
                            addLine(li, 2); // 2 garis kosong untuk jawaban
                            reflectionList.appendChild(li);
                        });
                        worksheetOutputContainer.appendChild(reflectionList);
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Pertanyaan refleksi belum dihasilkan.]', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 7. Penilaian Diri (Self-Assessment)
                    worksheetOutputContainer.appendChild(addElement('h2', 'Penilaian Diri (Berikan tanda centang pada kolom yang sesuai)', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    if (Array.isArray(parsedResponse.penilaianDiri) && parsedResponse.penilaianDiri.length > 0) {
                        const selfAssessmentTable = document.createElement('table');
                        selfAssessmentTable.className = 'w-full border-collapse border border-gray-400 mb-4 text-base';

                        const saThead = document.createElement('thead');
                        const saHeaderRow = document.createElement('tr');
                        ["Pernyataan", "Ya", "Tidak"].forEach(headerText => {
                            const th = document.createElement('th');
                            th.className = 'border border-gray-300 p-2 text-left bg-gray-100';
                            if (headerText === "Ya" || headerText === "Tidak") {
                                th.classList.add('text-center');
                            }
                            th.textContent = headerText;
                            saHeaderRow.appendChild(th);
                        });
                        saThead.appendChild(saHeaderRow);
                        selfAssessmentTable.appendChild(saThead);

                        const saTbody = document.createElement('tbody');
                        parsedResponse.penilaianDiri.forEach(statement => {
                            const row = document.createElement('tr');
                            const tdStatement = document.createElement('td');
                            tdStatement.className = 'border border-gray-300 p-2';
                            tdStatement.textContent = statement;
                            row.appendChild(tdStatement);

                            const tdYes = document.createElement('td');
                            tdYes.className = 'border border-gray-300 p-2 text-center';
                            tdYes.textContent = ''; // Kosongkan untuk dicentang manual
                            row.appendChild(tdYes);

                            const tdNo = document.createElement('td');
                            tdNo.className = 'border border-gray-300 p-2 text-center';
                            tdNo.textContent = ''; // Kosongkan untuk dicentang manual
                            row.appendChild(tdNo);
                            saTbody.appendChild(row);
                        });
                        selfAssessmentTable.appendChild(saTbody);
                        worksheetOutputContainer.appendChild(selfAssessmentTable);
                    } else {
                        worksheetOutputContainer.appendChild(addElement('p', '[Pernyataan penilaian diri belum dihasilkan.]', 'italic text-gray-500'));
                    }
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // 8. Kesimpulan & Tugas Tambahan (Opsional)
                    worksheetOutputContainer.appendChild(addElement('h2', 'Kesimpulan & Tugas Tambahan', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', parsedResponse.kesimpulanTugasTambahan || '[Kesimpulan dan tugas tambahan belum dihasilkan.]', 'mb-4 text-base leading-relaxed'));
                    worksheetOutputContainer.appendChild(document.createElement('hr'));

                    // BONUS: Ruang Catatan Bebas Siswa
                    worksheetOutputContainer.appendChild(addElement('h2', 'Ruang Catatan Bebas Siswa', 'text-lg font-semibold mt-6 mb-3 border-b border-gray-300 pb-1'));
                    worksheetOutputContainer.appendChild(addElement('p', parsedResponse.ruangCatatanBebas || '[Ruang catatan bebas siswa belum dihasilkan.]', 'text-sm italic text-gray-600 mb-2'));
                    addLine(worksheetOutputContainer, 5); // 5 garis kosong untuk catatan bebas

                    displayNotificationMessage('Lembar Aktivitas Siswa berhasil dibuat!', false);

                } else {
                    displayNotificationMessage("Maaf, gagal menghasilkan konten Lembar Aktivitas. Struktur respons dari AI tidak sesuai atau kosong. Coba lagi atau sesuaikan input Anda.", true);
                    worksheetOutputContainer.innerHTML = `<p class="text-center text-gray-500 italic">Gagal membuat LKPD. Silakan coba lagi dengan input yang lebih jelas.</p>`;
                }
            } catch (error) {
                console.error('Error saat menghasilkan konten Lembar Aktivitas:', error);
                // Menangkap error JSON parsing secara spesifik
                if (error.message.includes("Gagal mengurai respons JSON dari AI")) {
                    displayNotificationMessage(`${error.message}. Pastikan Kunci API Gemini Anda valid dan coba lagi.`, true);
                } else if (error.message.includes("Kesalahan API:")) {
                    displayNotificationMessage(`${error.message}. Pastikan Kunci API Anda valid dan memiliki kuota yang cukup.`, true);
                }
                else {
                    displayNotificationMessage(`Terjadi kesalahan tak terduga: ${error.message}. Pastikan semua bidang penting terisi dan koneksi internet stabil. Coba lagi.`, true);
                }
                worksheetOutputContainer.innerHTML = `<p class="text-center text-red-500 italic">Terjadi kesalahan: ${error.message}. Cek konsol browser (F12) untuk detail.</p>`;
            } finally {
                generateWorksheetBtn.disabled = false;
                generateWorksheetBtn.querySelector('span').textContent = 'Buat Lembar Aktivitas dengan AI';
            }
        };

        // Fungsi untuk menyalin teks yang dihasilkan ke clipboard
        const copyGeneratedWorksheet = () => {
            const range = document.createRange();
            range.selectNodeContents(worksheetOutputContainer); // Ubah dari selectNode menjadi selectNodeContents
            window.getSelection().removeAllRanges(); // Clear current selection
            window.getSelection().addRange(range); // Select the content of the div
            document.execCommand('copy');
            window.getSelection().removeAllRanges(); // Deselect
            displayNotificationMessage('Teks Lembar Aktivitas berhasil disalin ke clipboard!', false);
        };

        // Fungsi untuk membersihkan semua bidang formulir
        const resetFormFields = () => {
            teacherNameInputElem.value = '';
            gradeInputElem.value = '';
            subjectInputElem.value = '';
            learningTopicInputElem.value = '';
            competenceGoalsInputElem.value = '';
            apersepsiInputElem.value = '';
            petunjukKerjaInputElem.value = '';
            kegiatanIntiScenarioInputElem.value = '';
            questionDifficultySelectElem.value = 'menengah'; // Reset ke default
            worksheetOutputContainer.innerHTML = '<p class="text-center text-gray-500 italic">LKPD yang dihasilkan AI akan muncul di sini setelah Anda mengklik "Buat Lembar Aktivitas dengan AI".</p>';
            // Hapus kelas required-field jika ada
            document.querySelectorAll('.required-field').forEach(field => field.classList.remove('required-field'));
            displayNotificationMessage('Semua bidang formulir berhasil dibersihkan.', false);
        };

        // Inisialisasi utama setelah DOM dimuat sepenuhnya
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners untuk tombol utama aplikasi
            generateWorksheetBtn.addEventListener('click', generateWorksheetContent);
            copyWorksheetBtn.addEventListener('click', copyGeneratedWorksheet);
            clearFormBtn.addEventListener('click', resetFormFields);

            // Fungsi untuk mengatur modal Kunci API dan event listeners terkait
            const setupModalAndEventListeners = () => {
                const storedApiKey = localStorage.getItem('geminiApiKey');
                if (!storedApiKey || storedApiKey.trim() === '') {
                    geminiApiModal.classList.add('show'); // Tampilkan modal jika API Key kosong
                }
                modalApiInputElem.value = storedApiKey || ''; // Isi input dengan kunci yang tersimpan (jika ada)

                // Event Listeners untuk tombol di dalam modal
                saveApiBtn.addEventListener('click', storeApiKeyLocally);
                clearApiBtn.addEventListener('click', removeApiKeyLocally);
                closeApiModalBtn.addEventListener('click', () => {
                    geminiApiModal.classList.remove('show'); // Sembunyikan modal
                });

                // Event Listener untuk tombol pengaturan (ikon gear)
                settingsControlBtn.addEventListener('click', () => {
                    geminiApiModal.classList.add('show'); // Tampilkan modal saat tombol pengaturan diklik
                    modalApiInputElem.value = localStorage.getItem('geminiApiKey') || ''; // Perbarui nilai input modal
                });
            };
            
            setupModalAndEventListeners(); // Panggil fungsi inisialisasi modal saat DOM siap
        });
    </script>
</body>
</html>
